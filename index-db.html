<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTP/SFTP Manager - SQLiteç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: none;
            font-size: 16px;
        }
        
        .tab:hover {
            background: #e0e0e0;
        }
        
        .tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .success {
            background: #28a745;
        }
        
        .danger {
            background: #dc3545;
        }
        
        .warning {
            background: #ffc107;
            color: #333;
        }
        
        .profile-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .profile-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-actions {
            display: flex;
            gap: 10px;
        }
        
        .schedule-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        
        .schedule-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending { background: #ffc107; color: #333; }
        .status-executing { background: #17a2b8; color: white; }
        .status-completed { background: #28a745; color: white; }
        .status-failed { background: #dc3545; color: white; }
        
        .history-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            animation: slideIn 0.3s;
            z-index: 1000;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ FTP/SFTP Manager - SQLiteç‰ˆ</h1>
            <p>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã«ã‚ˆã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ </p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload', this)">ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            <button class="tab" onclick="switchTab('schedule', this)">ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</button>
            <button class="tab" onclick="switchTab('profiles', this)">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</button>
            <button class="tab" onclick="switchTab('history', this)">ğŸ“œ å±¥æ­´</button>
            <button class="tab" onclick="switchTab('stats', this)">ğŸ“Š çµ±è¨ˆ</button>
        </div>
        
        <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¿ãƒ– -->
        <div id="upload-tab" class="tab-content active">
            <h2>ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            
            <div class="form-group">
                <label>ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«:</label>
                <select id="upload-profile" onchange="window.syncProfileSelection(this.value)">
                    <option value="">-- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:</label>
                <input type="text" id="upload-directory" value="/" />
                <button onclick="browseServerDirectory()">ğŸ“ å‚ç…§</button>
            </div>
            
            <div class="form-group">
                <label>ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ:</label>
                <div id="file-drop-zone" style="
                    border: 3px dashed #ddd;
                    border-radius: 8px;
                    padding: 30px;
                    text-align: center;
                    background: #f9f9f9;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    position: relative;
                    min-height: 120px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                " onclick="document.getElementById('file-input').click()">
                    <div id="drop-zone-content">
                        <div style="font-size: 48px; color: #999; margin-bottom: 10px;">ğŸ“</div>
                        <div style="font-size: 16px; color: #666; margin-bottom: 5px;">
                            <strong>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</strong>
                        </div>
                        <div style="font-size: 14px; color: #999;">
                            ã¾ãŸã¯ <span style="color: #007bff; text-decoration: underline;">ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</span>
                        </div>
                    </div>
                    <div id="selected-files-display" style="
                        margin-top: 15px;
                        width: 100%;
                        display: none;
                    "></div>
                </div>
                <input type="file" id="file-input" multiple style="display: none;" />
            </div>
            
            <div class="form-group">
                <label>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰:</label>
                <select id="upload-mode" onchange="toggleScheduleOptions()">
                    <option value="immediate">å³åº§ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</option>
                    <option value="schedule">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«äºˆç´„</option>
                </select>
            </div>
            
            <div id="schedule-options" style="display: none;">
                <div class="form-group">
                    <label>äºˆç´„æ—¥æ™‚:</label>
                    <input type="datetime-local" id="schedule-time" />
                </div>
                
                <div class="form-group">
                    <label>ç¹°ã‚Šè¿”ã—:</label>
                    <select id="schedule-repeat">
                        <option value="once">1å›ã®ã¿</option>
                        <option value="daily">æ¯æ—¥</option>
                        <option value="weekly">æ¯é€±</option>
                        <option value="monthly">æ¯æœˆ</option>
                    </select>
                </div>
            </div>
            
            <button onclick="executeUpload()" class="success">
                ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
            </button>
        </div>
        
        <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ– -->
        <div id="schedule-tab" class="tab-content">
            <h2>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†</h2>
            <div id="schedule-list"></div>
        </div>
        
        <!-- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ãƒ– -->
        <div id="profiles-tab" class="tab-content">
            <h2>ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</h2>
            <button onclick="showAddProfileModal()" class="success">â• æ–°è¦ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</button>
            <div id="profile-list" style="margin-top: 20px;"></div>
        </div>
        
        <!-- å±¥æ­´ã‚¿ãƒ– -->
        <div id="history-tab" class="tab-content">
            <h2>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å±¥æ­´</h2>
            <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ãƒœã‚¿ãƒ³ï¼ˆå¾Œã§å‰Šé™¤ï¼‰ -->
            <div style="margin: 10px 0;">
                <button onclick="addTestHistory()" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">
                    ãƒ†ã‚¹ãƒˆå±¥æ­´ã‚’è¿½åŠ 
                </button>
                <button onclick="clearHistory()" style="background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                    å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
                </button>
            </div>
            <div id="history-list"></div>
        </div>
        
        <!-- çµ±è¨ˆã‚¿ãƒ– -->
        <div id="stats-tab" class="tab-content">
            <h2>çµ±è¨ˆæƒ…å ±</h2>
            <div class="stats-grid" id="stats-grid"></div>
            <canvas id="stats-chart" width="400" height="200"></canvas>
        </div>
    </div>
    
    <!-- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h2>ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š</h2>
            <div class="form-group">
                <label>ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å:</label>
                <input type="text" id="profile-name" />
            </div>
            <div class="form-group">
                <label>ãƒ—ãƒ­ãƒˆã‚³ãƒ«:</label>
                <select id="profile-protocol">
                    <option value="ftp">FTP</option>
                    <option value="sftp">SFTP</option>
                </select>
            </div>
            <div class="form-group">
                <label>ãƒ›ã‚¹ãƒˆ:</label>
                <input type="text" id="profile-host" />
            </div>
            <div class="form-group">
                <label>ãƒãƒ¼ãƒˆ:</label>
                <input type="number" id="profile-port" value="21" />
            </div>
            <div class="form-group">
                <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label>
                <input type="text" id="profile-username" />
            </div>
            <div class="form-group">
                <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="profile-password" />
            </div>
            <div class="form-group">
                <label>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" id="profile-directory" value="/" style="flex: 1;" />
                    <button type="button" onclick="browseProfileDirectory()" style="
                        background: #ffc107;
                        color: #212529;
                        border: none;
                        padding: 8px 15px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 14px;
                        white-space: nowrap;
                    ">ğŸ“ å‚ç…§</button>
                </div>
            </div>
            <button onclick="saveProfile()" class="success">ä¿å­˜</button>
            <button onclick="closeProfileModal()" class="danger">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button onclick="testConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        </div>
    </div>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ - æ‹¡å¼µæ©Ÿèƒ½é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
        window.addEventListener('error', function(event) {
            // Chromeæ‹¡å¼µæ©Ÿèƒ½é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç„¡è¦–
            if (event.message && (
                event.message.includes('Extension context invalidated') ||
                event.message.includes('message channel closed') ||
                event.message.includes('listener indicated an asynchronous response')
            )) {
                event.preventDefault();
                return true;
            }
        });

        // Promiseã®rejectionãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        window.addEventListener('unhandledrejection', function(event) {
            // æ‹¡å¼µæ©Ÿèƒ½é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
            if (event.reason && event.reason.message && (
                event.reason.message.includes('Extension context invalidated') ||
                event.reason.message.includes('message channel closed') ||
                event.reason.message.includes('listener indicated an asynchronous response')
            )) {
                event.preventDefault();
                return true;
            }
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let profiles = [];
        let schedules = [];
        let currentProfile = null;
        
        // åˆæœŸåŒ–
        async function initialize() {
            await loadProfiles();
            await loadSchedules();
            await loadHistory();
            await loadStats();
        }
        
        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleScheduleOptions() {
            const mode = document.getElementById('upload-mode').value;
            const scheduleOptions = document.getElementById('schedule-options');
            if (scheduleOptions) {
                scheduleOptions.style.display = mode === 'schedule' ? 'block' : 'none';
            }
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆLocalStorageã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®äº’æ›æ€§ï¼‰
        async function loadProfiles() {
            try {
                // LocalStorageã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                const saved = localStorage.getItem('profiles');
                if (saved) {
                    profiles = JSON.parse(saved);
                    updateProfileSelects();
                    updateProfileList();
                } else {
                    profiles = [];
                }
            } catch (error) {
                console.error('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                profiles = [];
            }
        }
        
        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ï¼ˆLocalStorageï¼‰
        async function loadSchedules() {
            try {
                const saved = localStorage.getItem('scheduledUploads');
                console.log('ğŸ“‚ LocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿:', saved);
                if (saved) {
                    schedules = JSON.parse(saved);
                    console.log('âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ:', schedules.length + 'ä»¶');
                } else {
                    schedules = [];
                    console.log('âš ï¸ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãªã—');
                }
                updateScheduleList();
            } catch (error) {
                console.error('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                schedules = [];
                updateScheduleList();
            }
        }
        
        // å±¥æ­´èª­ã¿è¾¼ã¿ï¼ˆLocalStorageï¼‰
        async function loadHistory() {
            try {
                const saved = localStorage.getItem('uploadHistory');
                console.log('ğŸ“š å±¥æ­´LocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿:', saved ? saved.length + 'bytes' : 'null');
                
                // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šLocalStorageã®å†…å®¹ã‚’ç¢ºèª
                if (!saved) {
                    console.log('âš ï¸ uploadHistoryã‚­ãƒ¼ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                    console.log('ğŸ“¦ LocalStorageã®ã™ã¹ã¦ã®ã‚­ãƒ¼:', Object.keys(localStorage));
                    updateHistoryList([]);
                    return;
                }
                
                const history = JSON.parse(saved);
                console.log('âœ… å±¥æ­´èª­ã¿è¾¼ã¿æˆåŠŸ:', history.length + 'ä»¶');
                console.log('ğŸ“‹ å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«:', history.slice(0, 3)); // æœ€åˆã®3ä»¶ã‚’è¡¨ç¤º
                updateHistoryList(history);
            } catch (error) {
                console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                updateHistoryList([]);
            }
        }
        
        // çµ±è¨ˆèª­ã¿è¾¼ã¿ï¼ˆLocalStorageï¼‰
        async function loadStats() {
            try {
                const saved = localStorage.getItem('uploadHistory');
                if (saved) {
                    const history = JSON.parse(saved);
                    const stats = {
                        total: history.length,
                        success: history.filter(h => h.status === 'success' || h.status === 'completed').length,
                        failed: history.filter(h => h.status === 'failed').length,
                        totalSize: history.reduce((sum, h) => sum + (h.file_size || h.fileSize || 0), 0),
                        totalDuration: history.reduce((sum, h) => sum + (h.duration_ms || 0), 0)
                    };
                    console.log('ğŸ“Š çµ±è¨ˆæƒ…å ±:', stats);
                    updateStats(stats);
                } else {
                    console.log('âš ï¸ å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    updateStats({ total: 0, success: 0, failed: 0, totalSize: 0, totalDuration: 0 });
                }
            } catch (error) {
                console.error('çµ±è¨ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                updateStats({ total: 0, success: 0, failed: 0, totalSize: 0, totalDuration: 0 });
            }
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ›´æ–°
        function updateProfileSelects() {
            const select = document.getElementById('upload-profile');
            select.innerHTML = '<option value="">-- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ --</option>';
            
            profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = `${profile.name} (${profile.protocol.toUpperCase()})`;
                select.appendChild(option);
            });
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆæ›´æ–°
        function updateProfileList() {
            const list = document.getElementById('profile-list');
            list.innerHTML = '';
            
            profiles.forEach(profile => {
                const card = document.createElement('div');
                card.className = 'profile-card';
                card.innerHTML = `
                    <div class="profile-info">
                        <strong>${profile.name}</strong><br>
                        ${profile.protocol.toUpperCase()} - ${profile.host}:${profile.port}<br>
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${profile.username}
                    </div>
                    <div class="profile-actions">
                        <button onclick="editProfile('${profile.id}')">ç·¨é›†</button>
                        <button onclick="deleteProfile('${profile.id}')" class="danger">å‰Šé™¤</button>
                        <button onclick="testProfileConnection('${profile.id}')">ãƒ†ã‚¹ãƒˆ</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }
        
        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒªã‚¹ãƒˆæ›´æ–°
        function updateScheduleList() {
            const list = document.getElementById('schedule-list');
            console.log('ğŸ“‹ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒªã‚¹ãƒˆæ›´æ–°:', schedules.length + 'ä»¶', schedules);
            
            if (!list) {
                console.error('âŒ schedule-listè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            list.innerHTML = '';
            
            if (schedules.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            schedules.forEach(schedule => {
                const item = document.createElement('div');
                item.className = 'schedule-item';
                const statusText = {
                    'pending': 'å¾…æ©Ÿä¸­',
                    'executing': 'å®Ÿè¡Œä¸­',
                    'completed': 'å®Œäº†',
                    'failed': 'å¤±æ•—'
                }[schedule.status] || schedule.status;
                
                const statusColor = {
                    'pending': '#ffc107',
                    'executing': '#17a2b8',
                    'completed': '#28a745',
                    'failed': '#dc3545'
                }[schedule.status] || '#6c757d';
                
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${schedule.name}</strong>
                            <span class="schedule-status" style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">
                                ${statusText}
                            </span><br>
                            <span style="color: #666;">
                                ${schedule.profile_name} â†’ ${schedule.upload_directory}
                            </span><br>
                            <span style="color: #333;">
                                ğŸ“… äºˆå®š: ${schedule.schedule_time ? new Date(schedule.schedule_time).toLocaleString('ja-JP') : 'å³åº§'}
                            </span><br>
                            <span style="color: #666; font-size: 12px;">
                                ğŸ”„ ç¹°ã‚Šè¿”ã—: ${schedule.schedule_type === 'once' ? '1å›ã®ã¿' : 
                                    schedule.schedule_type === 'daily' ? 'æ¯æ—¥' :
                                    schedule.schedule_type === 'weekly' ? 'æ¯é€±' :
                                    schedule.schedule_type === 'monthly' ? 'æ¯æœˆ' : schedule.schedule_type}
                            </span>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <button onclick="executeSchedule('${schedule.id}')" 
                                ${schedule.status === 'executing' ? 'disabled' : ''}
                                style="${schedule.status === 'executing' ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                ${schedule.status === 'executing' ? 'å®Ÿè¡Œä¸­...' : 'ä»Šã™ãå®Ÿè¡Œ'}
                            </button>
                            <button onclick="deleteSchedule('${schedule.id}')" class="danger">å‰Šé™¤</button>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        // å±¥æ­´ãƒªã‚¹ãƒˆæ›´æ–°
        function updateHistoryList(history) {
            const list = document.getElementById('history-list');
            console.log('ğŸ“œ å±¥æ­´ãƒªã‚¹ãƒˆæ›´æ–°:', history ? history.length + 'ä»¶' : '0ä»¶', history);
            
            if (!list) {
                console.error('âŒ history-listè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
            list.innerHTML = '';
            
            // å±¥æ­´ãŒãªã„å ´åˆ
            if (!history || history.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            // å±¥æ­´ã‚’æ–°ã—ã„é †ã«ä¸¦ã¹æ›¿ãˆ
            const sortedHistory = [...history].sort((a, b) => {
                return new Date(b.uploaded_at) - new Date(a.uploaded_at);
            });
            
            // å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆ
            sortedHistory.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¢ã‚¤ã‚³ãƒ³ã¨è‰²ã®è¨­å®š
                const statusIcon = (entry.status === 'success' || entry.status === 'completed') ? 'âœ…' : 'âŒ';
                const statusColor = (entry.status === 'success' || entry.status === 'completed') ? '#28a745' : '#dc3545';
                const statusText = (entry.status === 'success' || entry.status === 'completed') ? 'æˆåŠŸ' : 'å¤±æ•—';
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®è¡¨ç¤º
                const fileSize = entry.file_size ? `${(entry.file_size / 1024).toFixed(2)} KB` : '';
                
                // å®Ÿè¡Œæ™‚é–“ã®è¡¨ç¤º
                const duration = entry.duration_ms ? `${entry.duration_ms}ms` : '';
                
                // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œãƒ•ãƒ©ã‚°
                const scheduleFlag = entry.schedule_executed ? 'ğŸ“… ' : '';
                
                item.innerHTML = `
                    <div style="padding: 10px; border-left: 3px solid ${statusColor};">
                        <div style="display: flex; align-items: center; margin-bottom: 5px;">
                            ${statusIcon} 
                            <strong style="margin-left: 5px;">${scheduleFlag}${entry.file_name || 'Unknown'}</strong>
                        </div>
                        <div style="color: #666; font-size: 12px;">
                            <div>${entry.profile_name || 'Unknown'} - ${entry.upload_path || '/'}</div>
                            <div>${new Date(entry.uploaded_at).toLocaleString('ja-JP')}</div>
                            <div>
                                ${statusText}
                                ${fileSize ? ` â€¢ ${fileSize}` : ''}
                                ${duration ? ` â€¢ ${duration}` : ''}
                            </div>
                            ${entry.error_message ? `<div style="color: #dc3545;">ã‚¨ãƒ©ãƒ¼: ${entry.error_message}</div>` : ''}
                        </div>
                    </div>
                `;
                
                list.appendChild(item);
            });
        }
        
        // çµ±è¨ˆæ›´æ–°
        function updateStats(stats) {
            const grid = document.getElementById('stats-grid');
            if (!grid) {
                console.log('âš ï¸ stats-gridãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’äººé–“ãŒèª­ã¿ã‚„ã™ã„å½¢å¼ã«å¤‰æ›
            function formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // å¹³å‡æ™‚é–“ã‚’è¨ˆç®—
            const avgTime = stats.total > 0 ? Math.round((stats.totalDuration || 0) / stats.total / 1000) : 0;
            
            grid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total || 0}</div>
                    <div class="stat-label">ç·ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <div class="stat-value">${stats.success || 0}</div>
                    <div class="stat-label">æˆåŠŸ</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    <div class="stat-value">${stats.failed || 0}</div>
                    <div class="stat-label">å¤±æ•—</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <div class="stat-value">${avgTime}ç§’</div>
                    <div class="stat-label">å¹³å‡æ™‚é–“</div>
                </div>
            `;
            
            // è¿½åŠ ã®çµ±è¨ˆæƒ…å ±ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
            const additionalStats = `
                <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                    <div class="stat-value">${formatBytes(stats.totalSize || 0)}</div>
                    <div class="stat-label">ç·å®¹é‡</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
                    <div class="stat-value">${((stats.success || 0) / (stats.total || 1) * 100).toFixed(1)}%</div>
                    <div class="stat-label">æˆåŠŸç‡</div>
                </div>
            `;
            
            grid.innerHTML += additionalStats;
        }
        
        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
        async function executeUpload() {
            console.log('ğŸš€ executeUploadé–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸ');
            const profileId = document.getElementById('upload-profile').value;
            const files = document.getElementById('file-input').files;
            const mode = document.getElementById('upload-mode').value;
            const directory = document.getElementById('upload-directory').value;
            
            console.log('ğŸ“Š ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨­å®š:', {
                profileId,
                filesCount: files.length,
                mode,
                directory
            });
            
            if (!profileId) {
                showToast('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (files.length === 0) {
                showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (mode === 'immediate') {
                console.log('ğŸ“¤ å³åº§ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰');
                // å³åº§ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                for (const file of files) {
                    console.log('ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ä¸­:', file.name);
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('profile_id', profileId);
                    formData.append('uploadDirectory', directory);
                    
                    try {
                        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’formDataã«è¿½åŠ 
                        const profile = await getProfile(profileId);
                        if (profile) {
                            formData.append('host', profile.host);
                            formData.append('port', profile.port);
                            formData.append('username', profile.username);
                            formData.append('password', profile.password);
                            formData.append('protocol', profile.protocol || 'sftp');
                            formData.append('uploadPath', directory);
                        }
                        
                        console.log('ğŸŒ APIãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡:', '/api/upload');
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            body: formData
                        });
                        console.log('ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status);
                        
                        const result = await response.json();
                        if (result.success) {
                            // å±¥æ­´ã«è¿½åŠ 
                            const historyEntry = {
                                id: Date.now().toString(),
                                file_name: file.name,
                                profile_id: profileId,
                                profile_name: profile ? profile.name : 'Unknown',
                                upload_path: directory,
                                uploaded_at: new Date().toISOString(),
                                status: 'success',
                                file_size: file.size,
                                duration_ms: 0,
                                protocol: profile ? profile.protocol : 'unknown'
                            };
                            
                            // LocalStorageã‹ã‚‰æ—¢å­˜ã®å±¥æ­´ã‚’å–å¾—
                            const existingHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
                            existingHistory.unshift(historyEntry); // æ–°ã—ã„å±¥æ­´ã‚’å…ˆé ­ã«è¿½åŠ 
                            
                            // æœ€å¤§1000ä»¶ã¾ã§ä¿æŒ
                            if (existingHistory.length > 1000) {
                                existingHistory.splice(1000);
                            }
                            
                            localStorage.setItem('uploadHistory', JSON.stringify(existingHistory));
                            
                            showToast(`${file.name} ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`, 'success');
                        } else {
                            // å¤±æ•—ã‚‚å±¥æ­´ã«è¨˜éŒ²
                            const historyEntry = {
                                id: Date.now().toString(),
                                file_name: file.name,
                                profile_id: profileId,
                                profile_name: profile ? profile.name : 'Unknown',
                                upload_path: directory,
                                uploaded_at: new Date().toISOString(),
                                status: 'failed',
                                error_message: result.message || 'Upload failed',
                                file_size: file.size,
                                protocol: profile ? profile.protocol : 'unknown'
                            };
                            
                            const existingHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
                            existingHistory.unshift(historyEntry);
                            if (existingHistory.length > 1000) {
                                existingHistory.splice(1000);
                            }
                            localStorage.setItem('uploadHistory', JSON.stringify(existingHistory));
                            
                            showToast(`${file.name} ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${result.message}`, 'error');
                        }
                    } catch (error) {
                        showToast(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    }
                }
                
                // å±¥æ­´ã‚’æ›´æ–°
                await loadHistory();
                
            } else {
                console.log('ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«äºˆç´„ãƒ¢ãƒ¼ãƒ‰');
                // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«äºˆç´„
                const scheduleTime = document.getElementById('schedule-time').value;
                const scheduleRepeat = document.getElementById('schedule-repeat').value;
                console.log('â° ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š:', { scheduleTime, scheduleRepeat });
                
                for (const file of files) {
                    // FormDataã§ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡ï¼ˆBase64ã®å•é¡Œã‚’è§£æ±ºï¼‰
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('profile_id', profileId);
                    formData.append('name', file.name);
                    formData.append('upload_directory', directory);
                    formData.append('schedule_type', scheduleRepeat);
                    if (scheduleTime) {
                        formData.append('schedule_time', scheduleTime);
                    }
                    
                    try {
                        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ©Ÿèƒ½ã¯ä¸€æ™‚çš„ã«ä¿å­˜ã§ä»£æ›¿
                        const response = await fetch('/api/save-temp-file', {
                            method: 'POST',
                            body: formData
                        });
                            
                        const result = await response.json();
                        if (result.success) {
                            // LocalStorageã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¿å­˜
                            const profile = await getProfile(profileId);
                            const newSchedule = {
                                id: Date.now().toString(),
                                name: file.name,
                                profile_id: profileId,
                                profile_name: profile ? profile.name : 'Unknown',
                                upload_directory: directory,
                                schedule_time: scheduleTime || null,
                                schedule_type: scheduleRepeat || 'once',
                                status: 'pending',
                                fileId: result.fileId,
                                created_at: new Date().toISOString()
                            };
                            
                            console.log('ğŸ“ æ–°è¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ:', {
                                name: newSchedule.name,
                                schedule_time: newSchedule.schedule_time,
                                schedule_type: newSchedule.schedule_type,
                                å®Ÿè¡Œäºˆå®š: scheduleTime ? new Date(scheduleTime).toLocaleString() : 'å³åº§'
                            });
                            
                            // LocalStorageã‹ã‚‰æ—¢å­˜ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å–å¾—
                            const existingSchedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
                            console.log('ğŸ“ æ—¢å­˜ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:', existingSchedules.length + 'ä»¶');
                            existingSchedules.push(newSchedule);
                            localStorage.setItem('scheduledUploads', JSON.stringify(existingSchedules));
                            console.log('ğŸ’¾ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¿å­˜å®Œäº†:', existingSchedules.length + 'ä»¶');
                            
                            showToast(`${file.name} ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
                            await loadSchedules();
                        } else {
                            showToast(`ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ å¤±æ•—: ${result.message}`, 'error');
                        }
                    } catch (error) {
                        showToast(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    }
                }
            }
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ï¼‰
        async function saveProfile() {
            const profile = {
                name: document.getElementById('profile-name').value,
                protocol: document.getElementById('profile-protocol').value,
                host: document.getElementById('profile-host').value,
                port: document.getElementById('profile-port').value,
                username: document.getElementById('profile-username').value,
                password: document.getElementById('profile-password').value,
                default_directory: document.getElementById('profile-directory').value
            };
            
            const modal = document.getElementById('profile-modal');
            const profileId = modal.dataset.profileId;
            const isEditing = !!profileId;
            
            try {
                let result;
                
                if (isEditing) {
                    // Update existing profile
                    // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„ãŸã‚LocalStorageã§æ›´æ–°
                    const profiles = JSON.parse(localStorage.getItem('profiles') || '[]');
                    const profileIndex = profiles.findIndex(p => p.id === profileId);
                    if (profileIndex !== -1) {
                        profiles[profileIndex] = { ...profile, id: profileId };
                        localStorage.setItem('profiles', JSON.stringify(profiles));
                    }
                    result = { success: true, profile: { ...profile, id: profileId } };
                } else {
                    // Create new profile
                    // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„ãŸã‚LocalStorageã«æ–°è¦ä½œæˆ
                    const profiles = JSON.parse(localStorage.getItem('profiles') || '[]');
                    profile.id = Date.now().toString();
                    profiles.push(profile);
                    localStorage.setItem('profiles', JSON.stringify(profiles));
                    result = { success: true, profile: profile };
                }
                if (result.success) {
                    showToast(`ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’${isEditing ? 'æ›´æ–°' : 'ä¿å­˜'}ã—ã¾ã—ãŸ`, 'success');
                    closeProfileModal();
                    await loadProfiles();
                } else {
                    showToast(`ã‚¨ãƒ©ãƒ¼: ${result.message}`, 'error');
                }
            } catch (error) {
                showToast(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ
        async function executeSchedule(scheduleId) {
            console.log('ğŸš€ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ:', scheduleId);
            
            // LocalStorageã‹ã‚‰æœ€æ–°ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å–å¾—
            const schedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
            const schedule = schedules.find(s => s.id === scheduleId);
            if (!schedule) {
                console.error('âŒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', scheduleId);
                if (window.showToast) {
                    window.showToast('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                }
                return;
            }
            
            try {
                // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—
                const profiles = JSON.parse(localStorage.getItem('profiles') || '[]');
                const profile = profiles.find(p => p.id === schedule.profile_id);
                if (!profile) {
                    console.error('âŒ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', schedule.profile_id);
                    if (window.showToast) {
                        window.showToast('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    }
                    return;
                }
                
                // fileIdãŒã‚ã‚‹å ´åˆã¯æ–°ã—ã„æ–¹å¼ã€fileDataãŒã‚ã‚‹å ´åˆã¯æ—§æ–¹å¼
                if (schedule.fileId) {
                    // æ–°ã—ã„æ–¹å¼: ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨
                    console.log('ğŸ“ fileIdã‚’ä½¿ç”¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰:', schedule.fileId);
                    
                    const formData = new FormData();
                    formData.append('fileId', schedule.fileId);
                    formData.append('host', profile.host);
                    formData.append('port', profile.port);
                    formData.append('username', profile.username);
                    formData.append('password', profile.password);
                    formData.append('protocol', profile.protocol || 'sftp');
                    formData.append('uploadPath', schedule.upload_directory || '/');
                    
                    try {
                        const response = await fetch('/api/upload-temp-file', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                fileId: schedule.fileId,
                                host: profile.host,
                                port: profile.port,
                                username: profile.username,
                                password: profile.password,
                                protocol: profile.protocol || 'sftp',
                                uploadPath: schedule.upload_directory || '/'
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            showToast('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡ŒæˆåŠŸï¼', 'success');
                            
                            // å±¥æ­´ã«è¿½åŠ 
                            const historyEntry = {
                                id: Date.now().toString(),
                                file_name: schedule.name || schedule.fileName,
                                profile_id: schedule.profile_id,
                                profile_name: profile.name || 'Unknown',
                                upload_path: schedule.upload_directory || '/',
                                uploaded_at: new Date().toISOString(),
                                status: 'success',
                                file_size: 0, // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯ä¸æ˜
                                duration_ms: 0,
                                protocol: profile.protocol || 'sftp',
                                schedule_executed: true
                            };
                            
                            // LocalStorageã‹ã‚‰æ—¢å­˜ã®å±¥æ­´ã‚’å–å¾—
                            const existingHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
                            existingHistory.unshift(historyEntry); // æ–°ã—ã„å±¥æ­´ã‚’å…ˆé ­ã«è¿½åŠ 
                            
                            // æœ€å¤§1000ä»¶ã¾ã§ä¿æŒ
                            if (existingHistory.length > 1000) {
                                existingHistory.splice(1000);
                            }
                            
                            localStorage.setItem('uploadHistory', JSON.stringify(existingHistory));
                            
                            // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
                            schedule.status = 'completed';
                            const schedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
                            const index = schedules.findIndex(s => s.id === scheduleId);
                            if (index !== -1) {
                                schedules[index] = schedule;
                                localStorage.setItem('scheduledUploads', JSON.stringify(schedules));
                            }
                            
                            // å±¥æ­´ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                            await loadSchedules();
                            await loadHistory();
                            await loadStats();  // çµ±è¨ˆæƒ…å ±ã‚‚æ›´æ–°
                        } else {
                            showToast(`ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œå¤±æ•—: ${result.message}`, 'error');
                            
                            // å¤±æ•—ã‚‚å±¥æ­´ã«è¨˜éŒ²
                            const historyEntry = {
                                id: Date.now().toString(),
                                file_name: schedule.name || schedule.fileName,
                                profile_id: schedule.profile_id,
                                profile_name: profile.name || 'Unknown',
                                upload_path: schedule.upload_directory || '/',
                                uploaded_at: new Date().toISOString(),
                                status: 'failed',
                                error_message: result.message || 'Upload failed',
                                file_size: 0,
                                protocol: profile.protocol || 'sftp',
                                schedule_executed: true
                            };
                            
                            const existingHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
                            existingHistory.unshift(historyEntry);
                            if (existingHistory.length > 1000) {
                                existingHistory.splice(1000);
                            }
                            localStorage.setItem('uploadHistory', JSON.stringify(existingHistory));
                            
                            // å±¥æ­´ã‚’æ›´æ–°
                            await loadHistory();
                            await loadStats();
                        }
                    } catch (error) {
                        console.error('âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                        showToast(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    }
                    return;
                }
                
                // æ—§æ–¹å¼: Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                let fileData;
                try {
                    fileData = atob(schedule.fileData);
                } catch (e) {
                    console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—:', e);
                    if (window.showToast) {
                        window.showToast('ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã¾ã™', 'error');
                    }
                    return;
                }
                
                // Blobã‚’ä½œæˆã—ã¦FormDataã«è¿½åŠ 
                const blob = new Blob([fileData], { type: 'text/plain' });
                const file = new File([blob], schedule.fileName || schedule.name, { type: 'text/plain' });
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('profile_id', profile.id);
                formData.append('uploadDirectory', schedule.upload_directory || '/');
                
                if (window.showToast) {
                    window.showToast(`${schedule.name} ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...`, 'info');
                }
                
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡ŒæˆåŠŸ:', schedule.name);
                    if (window.showToast) {
                        window.showToast(`${schedule.name} ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒæˆåŠŸã—ã¾ã—ãŸ`, 'success');
                    }
                    
                    // å±¥æ­´ã«è¿½åŠ ï¼ˆæ—§æ–¹å¼ï¼‰
                    const historyEntry = {
                        id: Date.now().toString(),
                        file_name: schedule.fileName || schedule.name,
                        profile_id: schedule.profile_id,
                        profile_name: profile.name || 'Unknown',
                        upload_path: schedule.upload_directory || '/',
                        uploaded_at: new Date().toISOString(),
                        status: 'success',
                        file_size: 0, // Base64ã®å ´åˆã€æ­£ç¢ºãªã‚µã‚¤ã‚ºã¯ä¸æ˜
                        duration_ms: 0,
                        protocol: profile.protocol || 'unknown',
                        schedule_executed: true,
                        method: 'base64'
                    };
                    
                    // LocalStorageã‹ã‚‰æ—¢å­˜ã®å±¥æ­´ã‚’å–å¾—
                    const existingHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
                    existingHistory.unshift(historyEntry);
                    
                    // æœ€å¤§1000ä»¶ã¾ã§ä¿æŒ
                    if (existingHistory.length > 1000) {
                        existingHistory.splice(1000);
                    }
                    
                    localStorage.setItem('uploadHistory', JSON.stringify(existingHistory));
                    
                    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®Œäº†ã¨ã—ã¦ãƒãƒ¼ã‚¯ï¼ˆå‰Šé™¤ã¯ã—ãªã„ï¼‰
                    schedule.status = 'completed';
                    schedule.completed_at = new Date().toISOString();
                    
                    // LocalStorageã«ä¿å­˜
                    const updatedSchedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
                    const index = updatedSchedules.findIndex(s => s.id === scheduleId);
                    if (index !== -1) {
                        updatedSchedules[index] = schedule;
                        localStorage.setItem('scheduledUploads', JSON.stringify(updatedSchedules));
                    }
                    await loadSchedules();
                    await loadHistory();
                    await loadStats();
                    
                } else {
                    console.error('âŒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œå¤±æ•—:', result.message);
                    if (window.showToast) {
                        window.showToast(`${schedule.name} ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—: ${result.message}`, 'error');
                    }
                    
                    // å¤±æ•—ã‚‚å±¥æ­´ã«è¨˜éŒ²ï¼ˆæ—§æ–¹å¼ï¼‰
                    const historyEntry = {
                        id: Date.now().toString(),
                        file_name: schedule.fileName || schedule.name,
                        profile_id: schedule.profile_id,
                        profile_name: profile.name || 'Unknown',
                        upload_path: schedule.upload_directory || '/',
                        uploaded_at: new Date().toISOString(),
                        status: 'failed',
                        error_message: result.message || 'Upload failed',
                        file_size: 0,
                        protocol: profile.protocol || 'unknown',
                        schedule_executed: true,
                        method: 'base64'
                    };
                    
                    const existingHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
                    existingHistory.unshift(historyEntry);
                    if (existingHistory.length > 1000) {
                        existingHistory.splice(1000);
                    }
                    localStorage.setItem('uploadHistory', JSON.stringify(existingHistory));
                    
                    schedule.status = 'failed';
                    schedule.error_message = result.message;
                    
                    // LocalStorageã«ä¿å­˜
                    const updatedSchedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
                    const index = updatedSchedules.findIndex(s => s.id === scheduleId);
                    if (index !== -1) {
                        updatedSchedules[index] = schedule;
                        localStorage.setItem('scheduledUploads', JSON.stringify(updatedSchedules));
                    }
                    await loadSchedules();
                    await loadHistory();
                    await loadStats();
                }
                
                // å±¥æ­´ã¨çµ±è¨ˆã‚’æ›´æ–°
                await loadHistory();
                await loadStats();
                
            } catch (error) {
                console.error('âŒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
                if (window.showToast) {
                    window.showToast(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
                
                // ã‚¨ãƒ©ãƒ¼ã‚‚å±¥æ­´ã«è¨˜éŒ²
                const historyEntry = {
                    id: Date.now().toString(),
                    file_name: schedule.fileName || schedule.name || 'Unknown',
                    profile_id: schedule.profile_id,
                    profile_name: profile ? profile.name : 'Unknown',
                    upload_path: schedule.upload_directory || '/',
                    uploaded_at: new Date().toISOString(),
                    status: 'failed',
                    error_message: error.message || 'Unknown error',
                    file_size: 0,
                    protocol: profile ? profile.protocol : 'unknown',
                    schedule_executed: true
                };
                
                const existingHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
                existingHistory.unshift(historyEntry);
                if (existingHistory.length > 1000) {
                    existingHistory.splice(1000);
                }
                localStorage.setItem('uploadHistory', JSON.stringify(existingHistory));
                
                schedule.status = 'failed';
                schedule.error_message = error.message;
                
                // LocalStorageã«ä¿å­˜
                const updatedSchedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
                const index = updatedSchedules.findIndex(s => s.id === scheduleId);
                if (index !== -1) {
                    updatedSchedules[index] = schedule;
                    localStorage.setItem('scheduledUploads', JSON.stringify(updatedSchedules));
                }
                await loadSchedules();
                await loadHistory();
                await loadStats();
            }
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ï¼‰
        async function editProfile(profileId) {
            try {
                // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„ãŸã‚LocalStorageã‹ã‚‰å–å¾—
                const profiles = JSON.parse(localStorage.getItem('profiles') || '[]');
                const profile = profiles.find(p => p.id === profileId);
                
                if (profile) {
                    // Fill the form with existing profile data
                    document.getElementById('profile-name').value = profile.name;
                    document.getElementById('profile-protocol').value = profile.protocol;
                    document.getElementById('profile-host').value = profile.host;
                    document.getElementById('profile-port').value = profile.port;
                    document.getElementById('profile-username').value = profile.username;
                    document.getElementById('profile-password').value = profile.password;
                    document.getElementById('profile-directory').value = profile.default_directory || '/';
                    
                    // Set the profile ID for updating instead of creating
                    document.getElementById('profile-modal').dataset.profileId = profileId;
                    
                    // Show the modal
                    showAddProfileModal();
                    
                    showToast('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                } else {
                    showToast('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                showToast(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function deleteProfile(profileId) {
            if (!confirm('ã“ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„ãŸã‚LocalStorageã‹ã‚‰ç›´æ¥å‰Šé™¤
                const profiles = JSON.parse(localStorage.getItem('profiles') || '[]');
                const updatedProfiles = profiles.filter(p => p.id !== profileId);
                localStorage.setItem('profiles', JSON.stringify(updatedProfiles));
                const result = { success: true };
                if (result.success) {
                    showToast('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                    await loadProfiles();
                }
            } catch (error) {
                showToast(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        async function getProfile(profileId) {
            const profiles = JSON.parse(localStorage.getItem('profiles') || '[]');
            return profiles.find(p => p.id === profileId) || null;
        }
        
        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰Šé™¤ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ï¼‰

        async function deleteSchedule(scheduleId) {
            if (!confirm('ã“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            console.log('ğŸ—‘ï¸ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰Šé™¤:', scheduleId);
            
            try {
                // LocalStorageã‹ã‚‰å‰Šé™¤
                const schedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
                const filteredSchedules = schedules.filter(s => s.id !== scheduleId);
                localStorage.setItem('scheduledUploads', JSON.stringify(filteredSchedules));
                
                showToast('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                await loadSchedules();
            } catch (error) {
                showToast(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testProfileConnection(profileId) {
            try {
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ profile_id: profileId })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('æ¥ç¶šæˆåŠŸï¼', 'success');
                } else {
                    showToast(`æ¥ç¶šå¤±æ•—: ${result.message}`, 'error');
                }
                
                // å±¥æ­´ã‚’æ›´æ–°ï¼ˆæ¥ç¶šãƒ†ã‚¹ãƒˆã‚‚è¨˜éŒ²ã•ã‚Œã‚‹ï¼‰
                await loadHistory();
            } catch (error) {
                showToast(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã®æ¥ç¶šãƒ†ã‚¹ãƒˆé–¢æ•°
        async function testConnection() {
            try {
                // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æ¥ç¶šæƒ…å ±ã‚’å–å¾—
                const connectionData = {
                    host: document.getElementById('profile-host').value,
                    port: parseInt(document.getElementById('profile-port').value) || 22,
                    username: document.getElementById('profile-username').value,
                    password: document.getElementById('profile-password').value,
                    protocol: document.getElementById('profile-protocol').value || 'sftp'
                };
                
                // ãƒ‡ãƒãƒƒã‚°: å–å¾—ã—ãŸå€¤ã‚’ç¢ºèª
                console.log('æ¥ç¶šãƒ†ã‚¹ãƒˆ - å–å¾—ã—ãŸå€¤:', connectionData);
                
                // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
                if (!connectionData.host || !connectionData.username || !connectionData.password) {
                    console.log('å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯å¤±æ•—:', {
                        host: connectionData.host,
                        username: connectionData.username,
                        password: connectionData.password ? '***' : 'empty'
                    });
                    showToast('ãƒ›ã‚¹ãƒˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™', 'error');
                    return;
                }
                
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(connectionData)
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸï¼', 'success');
                } else {
                    showToast(`æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—: ${result.message}`, 'error');
                }
            } catch (error) {
                showToast(`æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Connection test error:', error);
            }
        }
        
        // UIé–¢æ•°
        function switchTab(tabName, element) {
            console.log('ğŸ“‘ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ:', tabName);
            
            // Remove active from all tabs and content
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active to clicked tab
            if (element) {
                element.classList.add('active');
            } else {
                // Fallback: find the tab by tabName
                document.querySelector(`[onclick*="switchTab('${tabName}')"]`)?.classList.add('active');
            }
            
            // Add active to corresponding content
            const targetContent = document.getElementById(`${tabName}-tab`);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // ã‚¿ãƒ–ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
            switch(tabName) {
                case 'history':
                    console.log('ğŸ“œ å±¥æ­´ã‚¿ãƒ–ã‚’é–‹ãã¾ã—ãŸ');
                    loadHistory();
                    break;
                case 'stats':
                    console.log('ğŸ“Š çµ±è¨ˆã‚¿ãƒ–ã‚’é–‹ãã¾ã—ãŸ');
                    loadStats();
                    break;
                case 'profiles':
                    console.log('ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ãƒ–ã‚’é–‹ãã¾ã—ãŸ');
                    loadProfiles();
                    break;
                case 'schedule':
                    console.log('ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ–ã‚’é–‹ãã¾ã—ãŸ');
                    loadSchedules();
                    break;
            }
        }
        
        function showAddProfileModal() {
            document.getElementById('profile-modal').style.display = 'block';
        }
        
        function closeProfileModal() {
            const modal = document.getElementById('profile-modal');
            modal.style.display = 'none';
            
            // Clear form and editing state
            document.getElementById('profile-name').value = '';
            document.getElementById('profile-protocol').value = 'ftp';
            document.getElementById('profile-host').value = '';
            document.getElementById('profile-port').value = '21';
            document.getElementById('profile-username').value = '';
            document.getElementById('profile-password').value = '';
            document.getElementById('profile-directory').value = '/';
            delete modal.dataset.profileId;
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.style.background = type === 'success' ? '#28a745' : 
                                    type === 'error' ? '#dc3545' : '#17a2b8';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´
        document.getElementById('upload-mode').addEventListener('change', (e) => {
            document.getElementById('schedule-options').style.display = 
                e.target.value === 'schedule' ? 'block' : 'none';
        });
        
        // ãƒ—ãƒ­ãƒˆã‚³ãƒ«å¤‰æ›´æ™‚ã®ãƒãƒ¼ãƒˆè‡ªå‹•è¨­å®š
        document.getElementById('profile-protocol').addEventListener('change', (e) => {
            document.getElementById('profile-port').value = e.target.value === 'sftp' ? '22' : '21';
        });
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', initialize);
        
        // ========== ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ©Ÿèƒ½ ==========
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã®åˆæœŸåŒ–
        function initializeDragAndDrop() {
            const dropZone = document.getElementById('file-drop-zone');
            const fileInput = document.getElementById('file-input');
            
            if (!dropZone || !fileInput) {
                console.error('âŒ ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            console.log('âœ… ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
            
            // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«
            const dragOverStyle = {
                'border-color': '#007bff',
                'background-color': '#e3f2fd',
                'transform': 'scale(1.02)'
            };
            
            const normalStyle = {
                'border-color': '#ddd',
                'background-color': '#f9f9f9',
                'transform': 'scale(1)'
            };
            
            // ãƒ‰ãƒ©ãƒƒã‚°é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆ
            dropZone.addEventListener('dragenter', handleDragEnter);
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('dragleave', handleDragLeave);
            dropZone.addEventListener('drop', handleDrop);
            
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
            fileInput.addEventListener('change', handleFileSelect);
            
            function handleDragEnter(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('ğŸ¯ ãƒ‰ãƒ©ãƒƒã‚°ã‚¨ãƒ³ã‚¿ãƒ¼');
                applyDragOverStyle();
                updateDropZoneContent('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ï¼', 'ğŸ“¥', '#007bff');
            }
            
            function handleDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'copy';
            }
            
            function handleDragLeave(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³å¤–ã«å®Œå…¨ã«å‡ºãŸå ´åˆã®ã¿ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                const rect = dropZone.getBoundingClientRect();
                if (e.clientX < rect.left || e.clientX > rect.right || 
                    e.clientY < rect.top || e.clientY > rect.bottom) {
                    console.log('ğŸšª ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–');
                    applyNormalStyle();
                    resetDropZoneContent();
                }
            }
            
            function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ï¼');
                
                applyNormalStyle();
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    console.log(`âœ… ${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã—ãŸ`);
                    
                    // FileListã‚’file inputã«è¨­å®š
                    fileInput.files = files;
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†ã‚’å®Ÿè¡Œ
                    handleFileSelect({ target: { files: files } });
                    
                    if (window.showToast) {
                        window.showToast(`${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¾ã—ãŸ`, 'success');
                    }
                } else {
                    console.warn('âš ï¸ ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“');
                    if (window.showToast) {
                        window.showToast('æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'error');
                    }
                }
            }
            
            function handleFileSelect(e) {
                const files = e.target.files;
                if (files.length === 0) {
                    resetDropZoneContent();
                    return;
                }
                
                console.log(`ğŸ“ ${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸ`);
                displaySelectedFiles(files);
            }
            
            // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨é–¢æ•°
            function applyDragOverStyle() {
                Object.assign(dropZone.style, dragOverStyle);
            }
            
            function applyNormalStyle() {
                Object.assign(dropZone.style, normalStyle);
            }
            
            // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°
            function updateDropZoneContent(text, icon, color) {
                const content = document.getElementById('drop-zone-content');
                if (content) {
                    content.innerHTML = `
                        <div style="font-size: 48px; color: ${color}; margin-bottom: 10px;">${icon}</div>
                        <div style="font-size: 16px; color: ${color}; margin-bottom: 5px;">
                            <strong>${text}</strong>
                        </div>
                    `;
                }
            }
            
            function resetDropZoneContent() {
                const content = document.getElementById('drop-zone-content');
                const display = document.getElementById('selected-files-display');
                
                if (content) {
                    content.innerHTML = `
                        <div style="font-size: 48px; color: #999; margin-bottom: 10px;">ğŸ“</div>
                        <div style="font-size: 16px; color: #666; margin-bottom: 5px;">
                            <strong>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</strong>
                        </div>
                        <div style="font-size: 14px; color: #999;">
                            ã¾ãŸã¯ <span style="color: #007bff; text-decoration: underline;">ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</span>
                        </div>
                    `;
                }
                
                if (display) {
                    display.style.display = 'none';
                    display.innerHTML = '';
                }
            }
            
            // é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤º
            function displaySelectedFiles(files) {
                const display = document.getElementById('selected-files-display');
                const content = document.getElementById('drop-zone-content');
                
                if (!display || !content) return;
                
                // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°
                content.innerHTML = `
                    <div style="font-size: 32px; color: #28a745; margin-bottom: 10px;">âœ…</div>
                    <div style="font-size: 16px; color: #28a745; margin-bottom: 5px;">
                        <strong>${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠæ¸ˆã¿</strong>
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        ã‚¯ãƒªãƒƒã‚¯ã—ã¦å¤‰æ›´å¯èƒ½
                    </div>
                `;
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                let fileListHTML = '<div style="text-align: left; max-height: 150px; overflow-y: auto;">';
                
                Array.from(files).forEach((file, index) => {
                    const size = (file.size / 1024).toFixed(2);
                    const icon = getFileIcon(file.name);
                    
                    fileListHTML += `
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 8px;
                            border-bottom: 1px solid #eee;
                            background: #fff;
                            border-radius: 4px;
                            margin-bottom: 4px;
                        ">
                            <div style="display: flex; align-items: center;">
                                <span style="margin-right: 8px;">${icon}</span>
                                <div>
                                    <div style="font-weight: bold; color: #333;">${file.name}</div>
                                    <div style="font-size: 12px; color: #666;">${size} KB</div>
                                </div>
                            </div>
                            <button onclick="removeFile(${index})" style="
                                background: #dc3545;
                                color: white;
                                border: none;
                                padding: 4px 8px;
                                border-radius: 3px;
                                cursor: pointer;
                                font-size: 12px;
                            ">âœ–</button>
                        </div>
                    `;
                });
                
                fileListHTML += '</div>';
                
                display.innerHTML = fileListHTML;
                display.style.display = 'block';
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã‹ã‚‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
            function getFileIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const iconMap = {
                    'csv': 'ğŸ“Š',
                    'txt': 'ğŸ“„',
                    'xml': 'ğŸ·ï¸',
                    'html': 'ğŸŒ',
                    'zip': 'ğŸ“¦',
                    'pdf': 'ğŸ“•',
                    'jpg': 'ğŸ–¼ï¸',
                    'jpeg': 'ğŸ–¼ï¸',
                    'png': 'ğŸ–¼ï¸',
                    'gif': 'ğŸ–¼ï¸',
                    'doc': 'ğŸ“',
                    'docx': 'ğŸ“',
                    'xls': 'ğŸ“ˆ',
                    'xlsx': 'ğŸ“ˆ'
                };
                
                return iconMap[ext] || 'ğŸ“„';
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼ˆãƒªã‚¹ãƒˆã‹ã‚‰ï¼‰
        function removeFile(index) {
            const fileInput = document.getElementById('file-input');
            if (!fileInput || !fileInput.files) return;
            
            // FileListã¯èª­ã¿å–ã‚Šå°‚ç”¨ãªã®ã§ã€æ–°ã—ã„DataTransferã‚’ä½œæˆ
            const dt = new DataTransfer();
            const files = Array.from(fileInput.files);
            
            files.forEach((file, i) => {
                if (i !== index) {
                    dt.items.add(file);
                }
            });
            
            fileInput.files = dt.files;
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            if (dt.files.length === 0) {
                resetDropZoneContent();
            } else {
                displaySelectedFiles(dt.files);
            }
            
            if (window.showToast) {
                window.showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'info');
            }
            
            function resetDropZoneContent() {
                const content = document.getElementById('drop-zone-content');
                const display = document.getElementById('selected-files-display');
                
                if (content) {
                    content.innerHTML = `
                        <div style="font-size: 48px; color: #999; margin-bottom: 10px;">ğŸ“</div>
                        <div style="font-size: 16px; color: #666; margin-bottom: 5px;">
                            <strong>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</strong>
                        </div>
                        <div style="font-size: 14px; color: #999;">
                            ã¾ãŸã¯ <span style="color: #007bff; text-decoration: underline;">ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</span>
                        </div>
                    `;
                }
                
                if (display) {
                    display.style.display = 'none';
                    display.innerHTML = '';
                }
            }
            
            function displaySelectedFiles(files) {
                const display = document.getElementById('selected-files-display');
                const content = document.getElementById('drop-zone-content');
                
                if (!display || !content) return;
                
                // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°
                content.innerHTML = `
                    <div style="font-size: 32px; color: #28a745; margin-bottom: 10px;">âœ…</div>
                    <div style="font-size: 16px; color: #28a745; margin-bottom: 5px;">
                        <strong>${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠæ¸ˆã¿</strong>
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        ã‚¯ãƒªãƒƒã‚¯ã—ã¦å¤‰æ›´å¯èƒ½
                    </div>
                `;
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºï¼ˆåŒã˜å®Ÿè£…ï¼‰
                let fileListHTML = '<div style="text-align: left; max-height: 150px; overflow-y: auto;">';
                
                Array.from(files).forEach((file, index) => {
                    const size = (file.size / 1024).toFixed(2);
                    const icon = getFileIcon(file.name);
                    
                    fileListHTML += `
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 8px;
                            border-bottom: 1px solid #eee;
                            background: #fff;
                            border-radius: 4px;
                            margin-bottom: 4px;
                        ">
                            <div style="display: flex; align-items: center;">
                                <span style="margin-right: 8px;">${icon}</span>
                                <div>
                                    <div style="font-weight: bold; color: #333;">${file.name}</div>
                                    <div style="font-size: 12px; color: #666;">${size} KB</div>
                                </div>
                            </div>
                            <button onclick="removeFile(${index})" style="
                                background: #dc3545;
                                color: white;
                                border: none;
                                padding: 4px 8px;
                                border-radius: 3px;
                                cursor: pointer;
                                font-size: 12px;
                            ">âœ–</button>
                        </div>
                    `;
                });
                
                fileListHTML += '</div>';
                
                display.innerHTML = fileListHTML;
                display.style.display = 'block';
            }
            
            function getFileIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const iconMap = {
                    'csv': 'ğŸ“Š',
                    'txt': 'ğŸ“„',
                    'xml': 'ğŸ·ï¸',
                    'html': 'ğŸŒ',
                    'zip': 'ğŸ“¦',
                    'pdf': 'ğŸ“•',
                    'jpg': 'ğŸ–¼ï¸',
                    'jpeg': 'ğŸ–¼ï¸',
                    'png': 'ğŸ–¼ï¸',
                    'gif': 'ğŸ–¼ï¸',
                    'doc': 'ğŸ“',
                    'docx': 'ğŸ“',
                    'xls': 'ğŸ“ˆ',
                    'xlsx': 'ğŸ“ˆ'
                };
                
                return iconMap[ext] || 'ğŸ“„';
            }
        }
        
        // åˆæœŸåŒ–ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’è¿½åŠ 
        setTimeout(() => {
            initializeDragAndDrop();
        }, 500);
        // ========== ã‚µãƒ¼ãƒãƒ¼é¸æŠåŒæœŸä¿®æ­£ ==========
        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’å®Œå…¨åŒæœŸã™ã‚‹é–¢æ•°
        window.syncProfileSelection = function(profileId) {
            console.log(`ğŸ”„ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åŒæœŸ: ${profileId}`);
            
            if (!profileId) {
                console.log('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«IDãŒç©ºã§ã™');
                // æœ€åˆã®æœ‰åŠ¹ãªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                const uploadSelect = document.getElementById('upload-profile');
                if (uploadSelect && uploadSelect.options.length > 1) {
                    uploadSelect.selectedIndex = 1;
                    profileId = uploadSelect.value;
                    console.log('ğŸ’¡ æœ€åˆã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•é¸æŠ:', profileId);
                } else {
                    return;
                }
            }
            
            try {
                // LocalStorageã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
                const profilesData = localStorage.getItem('profiles');
                if (!profilesData) {
                    console.error('âŒ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    console.log('ğŸ’¡ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚¿ãƒ–ã§æ–°ã—ã„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„');
                    return;
                }
                
                const profiles = JSON.parse(profilesData);
                let profile = profiles.find(p => p.id === profileId || p.id === String(profileId) || String(p.id) === String(profileId));
                
                if (!profile) {
                    console.error(`âŒ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${profileId}`);
                    console.log('ğŸ“Š åˆ©ç”¨å¯èƒ½ãªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«:');
                    profiles.forEach(p => console.log(`- ${p.name || p.host} (ID: ${p.id})`));
                    
                    // ä»£æ›¿ã¨ã—ã¦æœ€åˆã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨
                    if (profiles.length > 0) {
                        profile = profiles[0];
                        console.log(`ğŸ’¡ ä»£æ›¿ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨: ${profile.name || profile.host}`);
                        
                        // selectè¦ç´ ã‚‚æ›´æ–°
                        const uploadSelect = document.getElementById('upload-profile');
                        if (uploadSelect) {
                            uploadSelect.value = profile.id;
                        }
                    } else {
                        console.error('âŒ åˆ©ç”¨å¯èƒ½ãªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“');
                        return;
                    }
                }
                
                console.log('âœ… ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°:', profile);
                window.currentSelectedProfile = profile;
                
                // ã™ã¹ã¦ã®UIè¦ç´ ã‚’æ›´æ–°
                updateAllUIElements(profile);
                
                // LocalStorageã«ä¿å­˜
                localStorage.setItem('lastSelectedProfileId', profile.id);
                localStorage.setItem('currentProfile', JSON.stringify(profile));
                
                // æˆåŠŸé€šçŸ¥
                if (window.showToast) {
                    window.showToast(`${profile.name || profile.host}ã‚’é¸æŠã—ã¾ã—ãŸ`, 'success');
                }
                
            } catch (error) {
                console.error('âŒ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                if (window.showToast) {
                    window.showToast('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åŒæœŸã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            }
        };

        // ã™ã¹ã¦ã®UIè¦ç´ ã‚’æ›´æ–°
        function updateAllUIElements(profile) {
            console.log('ğŸ“ å…¨UIè¦ç´ ã‚’æ›´æ–°ä¸­...');
            
            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
            const uploadSelect = document.getElementById('upload-profile');
            if (uploadSelect) {
                uploadSelect.value = profile.id;
            }
            
            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
            const uploadDir = document.getElementById('upload-directory');
            if (uploadDir) {
                uploadDir.value = profile.default_directory || '/';
            }
            
            // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
            const event = new CustomEvent('profileChanged', { 
                detail: profile 
            });
            document.dispatchEvent(event);
            
            console.log('âœ… ã™ã¹ã¦ã®UIè¦ç´ ã‚’æ›´æ–°å®Œäº†');
        }

        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‹¡å¼µ
        const originalUploadSelectChange = document.getElementById('upload-profile');
        if (originalUploadSelectChange) {
            originalUploadSelectChange.addEventListener('change', function() {
                const profileId = this.value;
                if (profileId) {
                    syncProfileSelection(profileId);
                    if (window.showToast && window.currentSelectedProfile) {
                        const profile = window.currentSelectedProfile;
                        window.showToast(`${profile.name || profile.host}ã‚’é¸æŠã—ã¾ã—ãŸ`, 'success');
                    }
                }
            });
        }

        // ========== ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¿å­˜æ©Ÿèƒ½ä¿®æ­£ ==========
        // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå¤‰æ›´ã‚’è‡ªå‹•ä¿å­˜
        window.setupDirectorySaveHandler = function() {
            const uploadDirField = document.getElementById('upload-directory');
            if (!uploadDirField) return;
            
            let saveTimer = null;
            
            // å…¥åŠ›æ™‚ã®è‡ªå‹•ä¿å­˜ï¼ˆ1ç§’ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
            uploadDirField.addEventListener('input', function() {
                const newPath = this.value;
                clearTimeout(saveTimer);
                saveTimer = setTimeout(() => {
                    saveDirectoryToDatabase(newPath);
                }, 1000);
            });
            
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¢ã‚¦ãƒˆæ™‚ã®å³åº§ä¿å­˜
            uploadDirField.addEventListener('blur', function() {
                const newPath = this.value;
                clearTimeout(saveTimer);
                saveDirectoryToDatabase(newPath);
            });
            
            // Enterã‚­ãƒ¼ã§ã®ä¿å­˜
            uploadDirField.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const newPath = this.value;
                    clearTimeout(saveTimer);
                    saveDirectoryToDatabase(newPath);
                }
            });
        };

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä¿å­˜ (LocalStorageç‰ˆ)
        function saveDirectoryToDatabase(directoryPath) {
            console.log('ğŸ’¾ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’LocalStorageã«ä¿å­˜:', directoryPath);
            
            const uploadSelect = document.getElementById('upload-profile');
            if (!uploadSelect || !uploadSelect.value) {
                console.warn('âš ï¸ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            const profileId = uploadSelect.value;
            
            try {
                // LocalStorageã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const profilesData = localStorage.getItem('profiles');
                if (!profilesData) {
                    console.error('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const profiles = JSON.parse(profilesData);
                const profileIndex = profiles.findIndex(p => p.id === profileId);
                
                if (profileIndex === -1) {
                    console.error('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
                profiles[profileIndex].defaultDirectory = directoryPath;
                
                // LocalStorageã«ä¿å­˜
                localStorage.setItem('profiles', JSON.stringify(profiles));
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚‚æ›´æ–°
                if (window.currentSelectedProfile) {
                    window.currentSelectedProfile.defaultDirectory = directoryPath;
                    window.currentSelectedProfile.default_directory = directoryPath; // äº’æ›æ€§
                }
                
                console.log('âœ… ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’LocalStorageã«ä¿å­˜ã—ã¾ã—ãŸ:', directoryPath);
                
                if (window.showToast) {
                    window.showToast('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                }
                
            } catch (error) {
                console.error('âŒ LocalStorageæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                if (window.showToast) {
                    window.showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            }
        }

        // åˆæœŸåŒ–æ™‚ã«å®Ÿè¡Œ
        setTimeout(() => {
            setupDirectorySaveHandler();
            
            // æœ€å¾Œã«é¸æŠã•ã‚ŒãŸãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å…ƒ
            const lastProfileId = localStorage.getItem('lastSelectedProfileId');
            if (lastProfileId) {
                syncProfileSelection(lastProfileId);
            }
        }, 1000);

        // ========== è¦–è¦šçš„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‚ç…§æ©Ÿèƒ½ ==========
        
        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆæ™‚ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‚ç…§æ©Ÿèƒ½
        window.browseProfileDirectory = async function() {
            console.log('ğŸ“ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆæ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‚ç…§ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            
            // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å…¥åŠ›å€¤ã‚’å–å¾—
            const host = document.getElementById('profile-host').value;
            const port = document.getElementById('profile-port').value;
            const username = document.getElementById('profile-username').value;
            const password = document.getElementById('profile-password').value;
            const protocol = document.getElementById('profile-protocol').value;
            
            // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç¢ºèª
            if (!host || !username || !password) {
                if (window.showToast) {
                    window.showToast('å…ˆã«ãƒ›ã‚¹ãƒˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                }
                alert('å…ˆã«ãƒ›ã‚¹ãƒˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ä¸€æ™‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
            const tempProfile = {
                host: host,
                port: parseInt(port),
                username: username,
                password: password,
                protocol: protocol
            };
            
            // æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
            try {
                console.log('ğŸ”„ æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...', tempProfile);
                if (window.showToast) {
                    window.showToast('æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...', 'info');
                }
                
                // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã§ã‚‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š (30ç§’) - cURLãƒ†ã‚¹ãƒˆã§ã¯4ç§’ã‹ã‹ã‚‹ãŸã‚ä½™è£•ã‚’æŒãŸã›ã‚‹
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log('â° ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿ (30ç§’)');
                    controller.abort('Connection timeout after 30 seconds');
                }, 30000);
                
                console.log('ğŸ“¡ APIå‘¼ã³å‡ºã—é–‹å§‹...');
                
                let response;
                try {
                    response = await fetch('/api/test-connection', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(tempProfile),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    console.log('ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡æˆåŠŸ:', response.status, response.statusText);
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    console.error('ğŸ“¡ Fetch ã‚¨ãƒ©ãƒ¼:', fetchError);
                    throw fetchError;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                let result;
                try {
                    result = await response.json();
                    console.log('ğŸ“Š ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿è§£ææˆåŠŸ:', result);
                } catch (jsonError) {
                    console.error('ğŸ“Š JSONè§£æã‚¨ãƒ©ãƒ¼:', jsonError);
                    throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
                
                if (!result.success) {
                    if (window.showToast) {
                        window.showToast(`æ¥ç¶šå¤±æ•—: ${result.message}`, 'error');
                    }
                    alert(`æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.message}`);
                    return;
                }
                
                console.log('âœ… æ¥ç¶šæˆåŠŸï¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‹ãã¾ã™');
                if (window.showToast) {
                    window.showToast('æ¥ç¶šæˆåŠŸï¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é¸æŠã—ã¦ãã ã•ã„', 'success');
                }
                
                // æˆåŠŸæ™‚ã®å‡¦ç†ã‚’å³åº§ã«å®Ÿè¡Œ
                setTimeout(() => {
                    console.log('ğŸš€ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ–ãƒ©ã‚¦ã‚¶è¡¨ç¤ºå‡¦ç†é–‹å§‹...');
                    proceedWithDirectoryBrowser();
                }, 100);
                
            } catch (error) {
                console.error('âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                let errorMessage = error.message;
                
                if (error.name === 'AbortError') {
                    errorMessage = 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒ15ç§’ä»¥å†…ã«å®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸ';
                    console.log('ğŸ” AbortErrorè©³ç´°:', {
                        name: error.name,
                        message: error.message,
                        reason: error.reason || 'no reason provided'
                    });
                } else if (error.message && error.message.includes('fetch')) {
                    errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ';
                }
                
                if (window.showToast) {
                    window.showToast(`æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${errorMessage}`, 'error');
                }
                alert(`æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${errorMessage}`);
                return;
            }
            
            // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’è¨­å®š
            window.currentSelectedProfile = tempProfile;
            
            // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ–ãƒ©ã‚¦ã‚¶å‡¦ç†ã‚’åˆ¥é–¢æ•°ã§å®Ÿè¡Œ
            function proceedWithDirectoryBrowser() {
                console.log('ğŸš€ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ–ãƒ©ã‚¦ã‚¶ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆä¸­...');
                createProfileDirectoryBrowserModal();
                
                // åˆæœŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­å®šï¼ˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å€¤ã¾ãŸã¯'/'ï¼‰
                const currentDir = document.getElementById('profile-directory').value || '/';
                window.currentBrowsingPath = currentDir;
                console.log('ğŸ“‚ åˆæœŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š:', currentDir);
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                const modal = document.getElementById('profileDirectoryBrowserModal');
                console.log('ğŸ” ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ :', modal);
                if (modal) {
                    modal.style.display = 'block';
                    console.log('âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
                    
                    // ãƒ‘ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                    const pathEl = document.getElementById('currentProfileBrowsePath');
                    if (pathEl) pathEl.textContent = currentDir;
                    
                    const inputEl = document.getElementById('selectedProfileDirectoryPath');
                    if (inputEl) inputEl.value = currentDir;
                    
                    // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹ã‚’èª­ã¿è¾¼ã‚€
                    console.log('ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹ã‚’èª­ã¿è¾¼ã¿é–‹å§‹...');
                    loadProfileDirectoryContents(currentDir).catch(err => {
                        console.error('âŒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                        if (window.showToast) {
                            window.showToast('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                        }
                    });
                } else {
                    console.error('âŒ ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    if (window.showToast) {
                        window.showToast('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ–ãƒ©ã‚¦ã‚¶ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    }
                }
            }
        };
        
        window.browseServerDirectory = async function() {
            console.log('ğŸ“ è¦–è¦šçš„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‚ç…§ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            
            // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
            if (!window.currentSelectedProfile) {
                if (window.showToast) {
                    window.showToast('å…ˆã«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                }
                alert('å…ˆã«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ–ãƒ©ã‚¦ã‚¶ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆãƒ»è¡¨ç¤º
            createDirectoryBrowserModal();
            
            // åˆæœŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­å®š
            const currentDir = document.getElementById('upload-directory').value || 
                              window.currentSelectedProfile.defaultDirectory || 
                              window.currentSelectedProfile.default_directory || 
                              '/';
            
            window.currentBrowsingPath = currentDir;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            const modal = document.getElementById('directoryBrowserModal');
            if (modal) {
                modal.style.display = 'block';
                
                // ãƒ‘ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                const pathEl = document.getElementById('currentBrowsePath');
                if (pathEl) pathEl.textContent = currentDir;
                
                const inputEl = document.getElementById('selectedDirectoryPath');
                if (inputEl) inputEl.value = currentDir;
                
                // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹ã‚’èª­ã¿è¾¼ã‚€
                await loadDirectoryContents(currentDir);
            }
        };

        // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ–ãƒ©ã‚¦ã‚¶ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
        function createDirectoryBrowserModal() {
            // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤
            const existingModal = document.getElementById('directoryBrowserModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
            const modal = document.createElement('div');
            modal.id = 'directoryBrowserModal';
            modal.style.cssText = `
                display: none;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.4);
            `;
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.cssText = `
                background-color: #fefefe;
                margin: 5% auto;
                padding: 20px;
                border: 1px solid #888;
                width: 80%;
                max-width: 600px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            `;
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é¸æŠ</h2>
                    <span onclick="closeDirectoryBrowserModal()" style="
                        font-size: 28px;
                        font-weight: bold;
                        cursor: pointer;
                        color: #aaa;
                    ">&times;</span>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>ç¾åœ¨ã®ãƒ‘ã‚¹:</strong> 
                    <span id="currentBrowsePath" style="font-family: monospace; color: #007bff;">/</span>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>é¸æŠã•ã‚ŒãŸãƒ‘ã‚¹:</label>
                    <input type="text" id="selectedDirectoryPath" value="/" style="
                        width: 100%;
                        padding: 8px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        font-family: monospace;
                    ">
                </div>
                
                <div id="directoryLoading" style="display:none; text-align:center; padding:20px;">
                    <div>ğŸ”„ èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                
                <div id="directoryList" style="
                    border: 1px solid #ddd;
                    height: 300px;
                    overflow-y: auto;
                    background: #f9f9f9;
                    border-radius: 4px;
                    padding: 10px;
                ">
                    <div style="text-align: center; color: #999;">ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button onclick="confirmDirectorySelection()" style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                        margin-right: 10px;
                    ">âœ… é¸æŠ</button>
                    <button onclick="closeDirectoryBrowserModal()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                    ">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹ã‚’èª­ã¿è¾¼ã‚€
        async function loadDirectoryContents(path) {
            console.log('ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’èª­ã¿è¾¼ã¿:', path);
            
            const profile = window.currentSelectedProfile;
            if (!profile) {
                console.error('âŒ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            const loadingEl = document.getElementById('directoryLoading');
            const listEl = document.getElementById('directoryList');
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (listEl) listEl.innerHTML = '';
            
            try {
                const response = await fetch('/api/browse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        host: profile.host,
                        port: parseInt(profile.port),
                        username: profile.username,
                        password: profile.password,
                        protocol: profile.protocol,
                        path: path || '/'
                    })
                });
                
                const data = await response.json();
                console.log('ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);
                
                if (loadingEl) loadingEl.style.display = 'none';
                
                if (data.success) {
                    window.currentBrowsingPath = path;
                    
                    // ãƒ‘ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                    const pathEl = document.getElementById('currentBrowsePath');
                    if (pathEl) pathEl.textContent = path;
                    
                    const files = data.files || [];
                    if (listEl) {
                        let html = '';
                        
                        // è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ãƒªãƒ³ã‚¯
                        if (path !== '/') {
                            html += `
                                <div style="cursor:pointer; padding:8px; border-bottom:1px solid #eee; background:#fff; border-radius:4px; margin-bottom:2px;" 
                                     onclick="navigateToParentDirectory()">
                                    <span style="color:#007bff;">ğŸ“ ..</span>
                                </div>
                            `;
                        }
                        
                        // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
                        files.filter(f => f.type === 'directory').forEach(file => {
                            html += `
                                <div style="cursor:pointer; padding:8px; border-bottom:1px solid #eee; background:#fff; border-radius:4px; margin-bottom:2px;" 
                                     onclick="navigateToDirectory('${file.name}')">
                                    <span style="color:#007bff;">ğŸ“ ${file.name}</span>
                                </div>
                            `;
                        });
                        
                        // ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆè¡¨ç¤ºã®ã¿ï¼‰
                        files.filter(f => f.type === 'file').forEach(file => {
                            const size = file.size ? `(${(file.size/1024).toFixed(2)} KB)` : '';
                            html += `
                                <div style="padding:8px; border-bottom:1px solid #eee; color:#666; background:#f9f9f9; border-radius:4px; margin-bottom:2px;">
                                    ğŸ“„ ${file.name} <small>${size}</small>
                                </div>
                            `;
                        });
                        
                        listEl.innerHTML = html || '<div style="text-align:center; color:#999;">ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ç©ºã§ã™</div>';
                    }
                } else {
                    console.error('âŒ å‚ç…§å¤±æ•—:', data.message);
                    if (listEl) {
                        listEl.innerHTML = `<div style="color:red; padding:10px;">ã‚¨ãƒ©ãƒ¼: ${data.message}</div>`;
                    }
                }
            } catch (error) {
                console.error('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                if (loadingEl) loadingEl.style.display = 'none';
                if (listEl) {
                    listEl.innerHTML = `<div style="color:red; padding:10px;">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                }
            }
        }

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
        function navigateToDirectory(dirname) {
            const newPath = window.currentBrowsingPath === '/' 
                ? `/${dirname}` 
                : `${window.currentBrowsingPath}/${dirname}`;
            console.log('â¡ï¸ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•:', newPath);
            
            // é¸æŠãƒ‘ã‚¹ã‚‚æ›´æ–°
            const inputEl = document.getElementById('selectedDirectoryPath');
            if (inputEl) inputEl.value = newPath;
            
            loadDirectoryContents(newPath);
        }

        function navigateToParentDirectory() {
            const parts = window.currentBrowsingPath.split('/').filter(p => p);
            parts.pop();
            const newPath = parts.length > 0 ? '/' + parts.join('/') : '/';
            console.log('â¬†ï¸ è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•:', newPath);
            
            // é¸æŠãƒ‘ã‚¹ã‚‚æ›´æ–°
            const inputEl = document.getElementById('selectedDirectoryPath');
            if (inputEl) inputEl.value = newPath;
            
            loadDirectoryContents(newPath);
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeDirectoryBrowserModal() {
            const modal = document.getElementById('directoryBrowserModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé¸æŠã‚’ç¢ºèª
        function confirmDirectorySelection() {
            const selectedPath = document.getElementById('selectedDirectoryPath').value || '/';
            const uploadDir = document.getElementById('upload-directory');
            
            console.log('âœ… ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é¸æŠ:', selectedPath);
            
            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ›´æ–°
            if (uploadDir) {
                uploadDir.value = selectedPath;
            }
            
            // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
            if (window.currentSelectedProfile) {
                window.currentSelectedProfile.defaultDirectory = selectedPath;
                window.currentSelectedProfile.default_directory = selectedPath; // äº’æ›æ€§
                
                // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                const profilesData = localStorage.getItem('profiles');
                if (profilesData) {
                    try {
                        const profiles = JSON.parse(profilesData);
                        const profileIndex = profiles.findIndex(p => 
                            p.id === window.currentSelectedProfile.id || 
                            String(p.id) === String(window.currentSelectedProfile.id)
                        );
                        
                        if (profileIndex !== -1) {
                            profiles[profileIndex].defaultDirectory = selectedPath;
                            localStorage.setItem('profiles', JSON.stringify(profiles));
                            console.log('âœ… ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                        }
                    } catch (error) {
                        console.error('âŒ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
            }
            
            // é€šçŸ¥
            if (window.showToast) {
                window.showToast(`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ ${selectedPath} ã«è¨­å®šã—ã¾ã—ãŸ`, 'success');
            }
            
            closeDirectoryBrowserModal();
        }
        
        // ========== ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå°‚ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ–ãƒ©ã‚¦ã‚¶ ==========
        
        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå°‚ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ–ãƒ©ã‚¦ã‚¶ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
        function createProfileDirectoryBrowserModal() {
            // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤
            const existingModal = document.getElementById('profileDirectoryBrowserModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
            const modal = document.createElement('div');
            modal.id = 'profileDirectoryBrowserModal';
            modal.style.cssText = `
                display: none;
                position: fixed;
                z-index: 10001;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
            `;
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.cssText = `
                background-color: #fefefe;
                margin: 5% auto;
                padding: 20px;
                border: 1px solid #888;
                width: 80%;
                max-width: 600px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            `;
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">ğŸ“ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é¸æŠ</h2>
                    <span onclick="closeProfileDirectoryBrowserModal()" style="
                        font-size: 28px;
                        font-weight: bold;
                        cursor: pointer;
                        color: #aaa;
                    ">&times;</span>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>ç¾åœ¨ã®ãƒ‘ã‚¹:</strong> 
                    <span id="currentProfileBrowsePath" style="font-family: monospace; color: #007bff;">/</span>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>é¸æŠã•ã‚ŒãŸãƒ‘ã‚¹:</label>
                    <input type="text" id="selectedProfileDirectoryPath" value="/" style="
                        width: 100%;
                        padding: 8px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        font-family: monospace;
                    ">
                </div>
                
                <div id="profileDirectoryLoading" style="display:none; text-align:center; padding:20px;">
                    <div>ğŸ”„ èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                
                <div id="profileDirectoryList" style="
                    border: 1px solid #ddd;
                    height: 300px;
                    overflow-y: auto;
                    background: #f9f9f9;
                    border-radius: 4px;
                    padding: 10px;
                ">
                    <div style="text-align: center; color: #999;">ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button onclick="confirmProfileDirectorySelection()" style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                        margin-right: 10px;
                    ">âœ… é¸æŠ</button>
                    <button onclick="closeProfileDirectoryBrowserModal()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                    ">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å°‚ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹ã‚’èª­ã¿è¾¼ã‚€
        async function loadProfileDirectoryContents(path) {
            console.log('ğŸ“‚ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’èª­ã¿è¾¼ã¿:', path);
            
            const profile = window.currentSelectedProfile;
            if (!profile) {
                console.error('âŒ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            const loadingEl = document.getElementById('profileDirectoryLoading');
            const listEl = document.getElementById('profileDirectoryList');
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (listEl) listEl.innerHTML = '';
            
            try {
                // ğŸ”§ FIX: AbortControllerã‚’è¿½åŠ  (30ç§’)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log('â° ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿ (30ç§’)');
                    controller.abort('Directory browse timeout after 30 seconds');
                }, 30000);
                
                console.log('ğŸ“¡ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‚ç…§APIå‘¼ã³å‡ºã—é–‹å§‹...');
                const response = await fetch('/api/browse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        host: profile.host,
                        port: parseInt(profile.port),
                        username: profile.username,
                        password: profile.password,
                        protocol: profile.protocol,
                        path: path || '/'
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                console.log('ğŸ“¥ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‚ç…§ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡æˆåŠŸ:', response.status);
                
                const data = await response.json();
                console.log('ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);
                
                if (loadingEl) loadingEl.style.display = 'none';
                
                if (data.success) {
                    window.currentBrowsingPath = path;
                    
                    // ãƒ‘ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                    const pathEl = document.getElementById('currentProfileBrowsePath');
                    if (pathEl) pathEl.textContent = path;
                    
                    const files = data.files || [];
                    if (listEl) {
                        let html = '';
                        
                        // è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ãƒªãƒ³ã‚¯
                        if (path !== '/') {
                            html += `
                                <div style="cursor:pointer; padding:8px; border-bottom:1px solid #eee; background:#fff; border-radius:4px; margin-bottom:2px;" 
                                     onclick="navigateToProfileParentDirectory()">
                                    <span style="color:#007bff;">ğŸ“ ..</span>
                                </div>
                            `;
                        }
                        
                        // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
                        files.filter(f => f.type === 'directory').forEach(file => {
                            html += `
                                <div style="cursor:pointer; padding:8px; border-bottom:1px solid #eee; background:#fff; border-radius:4px; margin-bottom:2px;" 
                                     onclick="navigateToProfileDirectory('${file.name}')">
                                    <span style="color:#007bff;">ğŸ“ ${file.name}</span>
                                </div>
                            `;
                        });
                        
                        // ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆè¡¨ç¤ºã®ã¿ï¼‰
                        files.filter(f => f.type === 'file').forEach(file => {
                            const size = file.size ? `(${(file.size/1024).toFixed(2)} KB)` : '';
                            html += `
                                <div style="padding:8px; border-bottom:1px solid #eee; color:#666; background:#f9f9f9; border-radius:4px; margin-bottom:2px;">
                                    ğŸ“„ ${file.name} <small>${size}</small>
                                </div>
                            `;
                        });
                        
                        listEl.innerHTML = html || '<div style="text-align:center; color:#999;">ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ç©ºã§ã™</div>';
                    }
                } else {
                    console.error('âŒ å‚ç…§å¤±æ•—:', data.message);
                    if (listEl) {
                        listEl.innerHTML = `<div style="color:red; padding:10px;">ã‚¨ãƒ©ãƒ¼: ${data.message}</div>`;
                    }
                }
            } catch (error) {
                console.error('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                if (loadingEl) loadingEl.style.display = 'none';
                if (listEl) {
                    listEl.innerHTML = `<div style="color:red; padding:10px;">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                }
            }
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å°‚ç”¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
        function navigateToProfileDirectory(dirname) {
            const newPath = window.currentBrowsingPath === '/' 
                ? `/${dirname}` 
                : `${window.currentBrowsingPath}/${dirname}`;
            console.log('â¡ï¸ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•:', newPath);
            
            // é¸æŠãƒ‘ã‚¹ã‚‚æ›´æ–°
            const inputEl = document.getElementById('selectedProfileDirectoryPath');
            if (inputEl) inputEl.value = newPath;
            
            loadProfileDirectoryContents(newPath);
        }
        
        function navigateToProfileParentDirectory() {
            const parts = window.currentBrowsingPath.split('/').filter(p => p);
            parts.pop();
            const newPath = parts.length > 0 ? '/' + parts.join('/') : '/';
            console.log('â¬†ï¸ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç”¨è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•:', newPath);
            
            // é¸æŠãƒ‘ã‚¹ã‚‚æ›´æ–°
            const inputEl = document.getElementById('selectedProfileDirectoryPath');
            if (inputEl) inputEl.value = newPath;
            
            loadProfileDirectoryContents(newPath);
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å°‚ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé¸æŠç¢ºèª
        function confirmProfileDirectorySelection() {
            const selectedPath = document.getElementById('selectedProfileDirectoryPath').value || '/';
            const profileDirField = document.getElementById('profile-directory');
            
            console.log('âœ… ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é¸æŠ:', selectedPath);
            
            // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
            if (profileDirField) {
                profileDirField.value = selectedPath;
            }
            
            // é€šçŸ¥
            if (window.showToast) {
                window.showToast(`ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ ${selectedPath} ã«è¨­å®šã—ã¾ã—ãŸ`, 'success');
            }
            
            closeProfileDirectoryBrowserModal();
        }
        
        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å°‚ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeProfileDirectoryBrowserModal() {
            const modal = document.getElementById('profileDirectoryBrowserModal');
            if (modal) {
                modal.style.display = 'none';
            }
            // ä¸€æ™‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
            window.currentSelectedProfile = null;
        }
        
        // ã‚¨ã‚¤ãƒªã‚¢ã‚¹é–¢æ•°
        window.browseUploadDirectory = window.browseServerDirectory;
        window.browseServerDirectoryFromSidebar = window.browseServerDirectory;
        
        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªå‹•å®Ÿè¡Œãƒã‚§ãƒƒã‚«ãƒ¼
        let scheduleCheckInterval = null;
        
        function startScheduleChecker() {
            console.log('â° ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªå‹•å®Ÿè¡Œãƒã‚§ãƒƒã‚«ãƒ¼é–‹å§‹');
            
            // æ—¢å­˜ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ã‚¯ãƒªã‚¢
            if (scheduleCheckInterval) {
                clearInterval(scheduleCheckInterval);
            }
            
            // 1åˆ†ã”ã¨ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
            scheduleCheckInterval = setInterval(async () => {
                await checkAndExecuteSchedules();
            }, 60000); // 60ç§’ = 1åˆ†
            
            // åˆå›å³åº§ã«ãƒã‚§ãƒƒã‚¯
            checkAndExecuteSchedules();
        }
        
        async function checkAndExecuteSchedules() {
            const now = new Date();
            const schedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
            
            console.log(`ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯: ${now.toLocaleString()}, ${schedules.length}ä»¶ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«`);
            
            for (const schedule of schedules) {
                // pendingã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã¿ãƒã‚§ãƒƒã‚¯
                if (schedule.status !== 'pending') {
                    continue;
                }
                
                // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ™‚é–“ã®ç¢ºèª
                if (schedule.schedule_time) {
                    const scheduleTime = new Date(schedule.schedule_time);
                    
                    // ç¾åœ¨æ™‚åˆ»ãŒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ™‚åˆ»ã‚’éãã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆ1åˆ†ã®ä½™è£•ã‚’æŒã£ã¦ï¼‰
                    if (now >= scheduleTime) {
                        console.log(`ğŸ¯ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œæ™‚é–“åˆ°é”: ${schedule.name}`);
                        
                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å®Ÿè¡Œä¸­ã«æ›´æ–°
                        schedule.status = 'executing';
                        updateScheduleInStorage(schedule);
                        
                        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ
                        try {
                            await executeSchedule(schedule.id);
                            console.log(`âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œå®Œäº†: ${schedule.name}`);
                            
                            // ç¹°ã‚Šè¿”ã—è¨­å®šã®å‡¦ç†
                            if (schedule.schedule_type !== 'once') {
                                // æ¬¡å›å®Ÿè¡Œæ™‚é–“ã‚’è¨ˆç®—
                                const nextTime = calculateNextScheduleTime(scheduleTime, schedule.schedule_type);
                                schedule.schedule_time = nextTime.toISOString();
                                schedule.status = 'pending';
                                console.log(`ğŸ”„ æ¬¡å›å®Ÿè¡Œäºˆå®š: ${nextTime.toLocaleString()}`);
                                updateScheduleInStorage(schedule);
                            } else {
                                // ä¸€å›ã®ã¿ã®å ´åˆã¯å®Œäº†
                                schedule.status = 'completed';
                                updateScheduleInStorage(schedule);
                            }
                        } catch (error) {
                            console.error(`âŒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${schedule.name}`, error);
                            schedule.status = 'failed';
                            updateScheduleInStorage(schedule);
                        }
                        
                        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒªã‚¹ãƒˆã¨å±¥æ­´ã‚’æ›´æ–°
                        await loadSchedules();
                        await loadHistory();
                    }
                } else {
                    // schedule_timeãŒãªã„å ´åˆã¯å³åº§ã«å®Ÿè¡Œï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
                    console.log(`âš ï¸ å³åº§å®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«: ${schedule.name}`);
                    await executeSchedule(schedule.id);
                }
            }
        }
        
        function calculateNextScheduleTime(currentTime, scheduleType) {
            const nextTime = new Date(currentTime);
            
            switch (scheduleType) {
                case 'daily':
                    nextTime.setDate(nextTime.getDate() + 1);
                    break;
                case 'weekly':
                    nextTime.setDate(nextTime.getDate() + 7);
                    break;
                case 'monthly':
                    nextTime.setMonth(nextTime.getMonth() + 1);
                    break;
                default:
                    // 'once' or unknown type
                    break;
            }
            
            return nextTime;
        }
        
        function updateScheduleInStorage(updatedSchedule) {
            const schedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
            const index = schedules.findIndex(s => s.id === updatedSchedule.id);
            if (index !== -1) {
                schedules[index] = updatedSchedule;
                localStorage.setItem('scheduledUploads', JSON.stringify(schedules));
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
            initialize().then(() => {
                console.log('âœ… ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
                // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚«ãƒ¼ã‚’é–‹å§‹
                startScheduleChecker();
            }).catch(error => {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            });
        });
        
        // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹æ™‚ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ã‚¯ãƒªã‚¢
        // ãƒ†ã‚¹ãƒˆå±¥æ­´è¿½åŠ é–¢æ•°ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        function addTestHistory() {
            const existingHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
            const newEntry = {
                id: Date.now().toString(),
                file_name: `test_${Date.now()}.csv`,
                profile_name: "Test Server",
                upload_path: "/test/directory",
                uploaded_at: new Date().toISOString(),
                status: Math.random() > 0.5 ? "success" : "failed",
                file_size: Math.floor(Math.random() * 10000) + 1000,
                duration_ms: Math.floor(Math.random() * 5000) + 100,
                protocol: "sftp",
                error_message: Math.random() > 0.5 ? null : "Test error message"
            };
            existingHistory.unshift(newEntry);
            localStorage.setItem('uploadHistory', JSON.stringify(existingHistory));
            console.log('âœ… ãƒ†ã‚¹ãƒˆå±¥æ­´ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', newEntry);
            loadHistory();
            showToast('ãƒ†ã‚¹ãƒˆå±¥æ­´ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        }
        
        // å±¥æ­´ã‚¯ãƒªã‚¢é–¢æ•°ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        function clearHistory() {
            if (confirm('æœ¬å½“ã«å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('uploadHistory');
                console.log('ğŸ—‘ï¸ å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                loadHistory();
                showToast('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
            }
        }
        
        window.addEventListener('beforeunload', () => {
            if (scheduleCheckInterval) {
                clearInterval(scheduleCheckInterval);
            }
        });

    </script>
</body>
</html>
