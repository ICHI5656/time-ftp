<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTP/SFTP Manager - SQLite版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: none;
            font-size: 16px;
        }
        
        .tab:hover {
            background: #e0e0e0;
        }
        
        .tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .success {
            background: #28a745;
        }
        
        .danger {
            background: #dc3545;
        }
        
        .warning {
            background: #ffc107;
            color: #333;
        }
        
        .profile-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .profile-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-actions {
            display: flex;
            gap: 10px;
        }
        
        .schedule-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        
        .schedule-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending { background: #ffc107; color: #333; }
        .status-executing { background: #17a2b8; color: white; }
        .status-completed { background: #28a745; color: white; }
        .status-failed { background: #dc3545; color: white; }
        
        .history-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            animation: slideIn 0.3s;
            z-index: 1000;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 FTP/SFTP Manager - SQLite版</h1>
            <p>データベース管理によるスケジュールアップロードシステム</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload', this)">📤 アップロード</button>
            <button class="tab" onclick="switchTab('schedule', this)">📅 スケジュール</button>
            <button class="tab" onclick="switchTab('profiles', this)">👤 プロファイル</button>
            <button class="tab" onclick="switchTab('history', this)">📜 履歴</button>
            <button class="tab" onclick="switchTab('stats', this)">📊 統計</button>
        </div>
        
        <!-- アップロードタブ -->
        <div id="upload-tab" class="tab-content active">
            <h2>ファイルアップロード</h2>
            
            <div class="form-group">
                <label>サーバープロファイル:</label>
                <select id="upload-profile" onchange="window.syncProfileSelection(this.value)">
                    <option value="">-- プロファイルを選択 --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>アップロードディレクトリ:</label>
                <input type="text" id="upload-directory" value="/" />
                <button onclick="browseServerDirectory()">📁 参照</button>
            </div>
            
            <div class="form-group">
                <label>ファイル選択:</label>
                <div id="file-drop-zone" style="
                    border: 3px dashed #ddd;
                    border-radius: 8px;
                    padding: 30px;
                    text-align: center;
                    background: #f9f9f9;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    position: relative;
                    min-height: 120px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                " onclick="document.getElementById('file-input').click()">
                    <div id="drop-zone-content">
                        <div style="font-size: 48px; color: #999; margin-bottom: 10px;">📁</div>
                        <div style="font-size: 16px; color: #666; margin-bottom: 5px;">
                            <strong>ファイルをドラッグ&ドロップ</strong>
                        </div>
                        <div style="font-size: 14px; color: #999;">
                            または <span style="color: #007bff; text-decoration: underline;">クリックして選択</span>
                        </div>
                    </div>
                    <div id="selected-files-display" style="
                        margin-top: 15px;
                        width: 100%;
                        display: none;
                    "></div>
                </div>
                <input type="file" id="file-input" multiple style="display: none;" />
            </div>
            
            <div class="form-group">
                <label>アップロードモード:</label>
                <select id="upload-mode" onchange="toggleScheduleOptions()">
                    <option value="immediate">即座にアップロード</option>
                    <option value="schedule">スケジュール予約</option>
                </select>
            </div>
            
            <div id="schedule-options" style="display: none;">
                <div class="form-group">
                    <label>予約日時:</label>
                    <input type="datetime-local" id="schedule-time" />
                </div>
                
                <div class="form-group">
                    <label>繰り返し:</label>
                    <select id="schedule-repeat">
                        <option value="once">1回のみ</option>
                        <option value="daily">毎日</option>
                        <option value="weekly">毎週</option>
                        <option value="monthly">毎月</option>
                    </select>
                </div>
            </div>
            
            <button onclick="executeUpload()" class="success">
                🚀 アップロード実行
            </button>
        </div>
        
        <!-- スケジュールタブ -->
        <div id="schedule-tab" class="tab-content">
            <h2>スケジュール管理</h2>
            <div id="schedule-list"></div>
        </div>
        
        <!-- プロファイルタブ -->
        <div id="profiles-tab" class="tab-content">
            <h2>サーバープロファイル</h2>
            <button onclick="showAddProfileModal()" class="success">➕ 新規プロファイル</button>
            <div id="profile-list" style="margin-top: 20px;"></div>
        </div>
        
        <!-- 履歴タブ -->
        <div id="history-tab" class="tab-content">
            <h2>アップロード履歴</h2>
            <!-- デバッグ用ボタン（後で削除） -->
            <div style="margin: 10px 0;">
                <button onclick="addTestHistory()" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">
                    テスト履歴を追加
                </button>
                <button onclick="clearHistory()" style="background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                    履歴をクリア
                </button>
            </div>
            <div id="history-list"></div>
        </div>
        
        <!-- 統計タブ -->
        <div id="stats-tab" class="tab-content">
            <h2>統計情報</h2>
            <div class="stats-grid" id="stats-grid"></div>
            <canvas id="stats-chart" width="400" height="200"></canvas>
        </div>
    </div>
    
    <!-- プロファイル追加モーダル -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h2>サーバープロファイル設定</h2>
            <div class="form-group">
                <label>プロファイル名:</label>
                <input type="text" id="profile-name" />
            </div>
            <div class="form-group">
                <label>プロトコル:</label>
                <select id="profile-protocol">
                    <option value="ftp">FTP</option>
                    <option value="sftp">SFTP</option>
                </select>
            </div>
            <div class="form-group">
                <label>ホスト:</label>
                <input type="text" id="profile-host" />
            </div>
            <div class="form-group">
                <label>ポート:</label>
                <input type="number" id="profile-port" value="21" />
            </div>
            <div class="form-group">
                <label>ユーザー名:</label>
                <input type="text" id="profile-username" />
            </div>
            <div class="form-group">
                <label>パスワード:</label>
                <input type="password" id="profile-password" />
            </div>
            <div class="form-group">
                <label>デフォルトディレクトリ:</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" id="profile-directory" value="/" style="flex: 1;" />
                    <button type="button" onclick="browseProfileDirectory()" style="
                        background: #ffc107;
                        color: #212529;
                        border: none;
                        padding: 8px 15px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 14px;
                        white-space: nowrap;
                    ">📁 参照</button>
                </div>
            </div>
            <button onclick="saveProfile()" class="success">保存</button>
            <button onclick="closeProfileModal()" class="danger">キャンセル</button>
            <button onclick="testConnection()">接続テスト</button>
        </div>
    </div>
    
    <script>
        // グローバルエラーハンドラー - 拡張機能関連のエラーを無視
        window.addEventListener('error', function(event) {
            // Chrome拡張機能関連のエラーメッセージを無視
            if (event.message && (
                event.message.includes('Extension context invalidated') ||
                event.message.includes('message channel closed') ||
                event.message.includes('listener indicated an asynchronous response')
            )) {
                event.preventDefault();
                return true;
            }
        });

        // Promiseのrejectionハンドラー
        window.addEventListener('unhandledrejection', function(event) {
            // 拡張機能関連のエラーを無視
            if (event.reason && event.reason.message && (
                event.reason.message.includes('Extension context invalidated') ||
                event.reason.message.includes('message channel closed') ||
                event.reason.message.includes('listener indicated an asynchronous response')
            )) {
                event.preventDefault();
                return true;
            }
        });

        // グローバル変数
        let profiles = [];
        let schedules = [];
        let currentProfile = null;
        
        // 初期化
        async function initialize() {
            await loadProfiles();
            await loadSchedules();
            await loadHistory();
            await loadStats();
        }
        
        // スケジュールオプションの表示/非表示切り替え
        function toggleScheduleOptions() {
            const mode = document.getElementById('upload-mode').value;
            const scheduleOptions = document.getElementById('schedule-options');
            if (scheduleOptions) {
                scheduleOptions.style.display = mode === 'schedule' ? 'block' : 'none';
            }
        }
        
        // プロファイル読み込み（LocalStorageとデータベースの互換性）
        async function loadProfiles() {
            try {
                // LocalStorageからプロファイルを読み込み（フォールバック）
                const saved = localStorage.getItem('profiles');
                if (saved) {
                    profiles = JSON.parse(saved);
                    updateProfileSelects();
                    updateProfileList();
                } else {
                    profiles = [];
                }
            } catch (error) {
                console.error('プロファイル読み込みエラー:', error);
                profiles = [];
            }
        }
        
        // スケジュール読み込み（LocalStorage）
        async function loadSchedules() {
            try {
                const saved = localStorage.getItem('scheduledUploads');
                console.log('📂 LocalStorageから読み込み:', saved);
                if (saved) {
                    schedules = JSON.parse(saved);
                    console.log('✅ スケジュール読み込み成功:', schedules.length + '件');
                } else {
                    schedules = [];
                    console.log('⚠️ スケジュールなし');
                }
                updateScheduleList();
            } catch (error) {
                console.error('スケジュール読み込みエラー:', error);
                schedules = [];
                updateScheduleList();
            }
        }
        
        // 履歴読み込み（LocalStorage）
        async function loadHistory() {
            try {
                const saved = localStorage.getItem('uploadHistory');
                console.log('📚 履歴LocalStorageから読み込み:', saved ? saved.length + 'bytes' : 'null');
                
                // デバッグ用：LocalStorageの内容を確認
                if (!saved) {
                    console.log('⚠️ uploadHistoryキーが存在しません');
                    console.log('📦 LocalStorageのすべてのキー:', Object.keys(localStorage));
                    updateHistoryList([]);
                    return;
                }
                
                const history = JSON.parse(saved);
                console.log('✅ 履歴読み込み成功:', history.length + '件');
                console.log('📋 履歴データサンプル:', history.slice(0, 3)); // 最初の3件を表示
                updateHistoryList(history);
            } catch (error) {
                console.error('履歴読み込みエラー:', error);
                updateHistoryList([]);
            }
        }
        
        // 統計読み込み（LocalStorage）
        async function loadStats() {
            try {
                const saved = localStorage.getItem('uploadHistory');
                if (saved) {
                    const history = JSON.parse(saved);
                    const stats = {
                        total: history.length,
                        success: history.filter(h => h.status === 'success' || h.status === 'completed').length,
                        failed: history.filter(h => h.status === 'failed').length,
                        totalSize: history.reduce((sum, h) => sum + (h.file_size || h.fileSize || 0), 0),
                        totalDuration: history.reduce((sum, h) => sum + (h.duration_ms || 0), 0)
                    };
                    console.log('📊 統計情報:', stats);
                    updateStats(stats);
                } else {
                    console.log('⚠️ 履歴データがありません');
                    updateStats({ total: 0, success: 0, failed: 0, totalSize: 0, totalDuration: 0 });
                }
            } catch (error) {
                console.error('統計読み込みエラー:', error);
                updateStats({ total: 0, success: 0, failed: 0, totalSize: 0, totalDuration: 0 });
            }
        }
        
        // プロファイル選択更新
        function updateProfileSelects() {
            const select = document.getElementById('upload-profile');
            select.innerHTML = '<option value="">-- プロファイルを選択 --</option>';
            
            profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = `${profile.name} (${profile.protocol.toUpperCase()})`;
                select.appendChild(option);
            });
        }
        
        // プロファイルリスト更新
        function updateProfileList() {
            const list = document.getElementById('profile-list');
            list.innerHTML = '';
            
            profiles.forEach(profile => {
                const card = document.createElement('div');
                card.className = 'profile-card';
                card.innerHTML = `
                    <div class="profile-info">
                        <strong>${profile.name}</strong><br>
                        ${profile.protocol.toUpperCase()} - ${profile.host}:${profile.port}<br>
                        ユーザー: ${profile.username}
                    </div>
                    <div class="profile-actions">
                        <button onclick="editProfile('${profile.id}')">編集</button>
                        <button onclick="deleteProfile('${profile.id}')" class="danger">削除</button>
                        <button onclick="testProfileConnection('${profile.id}')">テスト</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }
        
        // スケジュールリスト更新
        function updateScheduleList() {
            const list = document.getElementById('schedule-list');
            console.log('📋 スケジュールリスト更新:', schedules.length + '件', schedules);
            
            if (!list) {
                console.error('❌ schedule-list要素が見つかりません');
                return;
            }
            
            list.innerHTML = '';
            
            if (schedules.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">スケジュールがありません</div>';
                return;
            }
            
            schedules.forEach(schedule => {
                const item = document.createElement('div');
                item.className = 'schedule-item';
                const statusText = {
                    'pending': '待機中',
                    'executing': '実行中',
                    'completed': '完了',
                    'failed': '失敗'
                }[schedule.status] || schedule.status;
                
                const statusColor = {
                    'pending': '#ffc107',
                    'executing': '#17a2b8',
                    'completed': '#28a745',
                    'failed': '#dc3545'
                }[schedule.status] || '#6c757d';
                
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${schedule.name}</strong>
                            <span class="schedule-status" style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">
                                ${statusText}
                            </span><br>
                            <span style="color: #666;">
                                ${schedule.profile_name} → ${schedule.upload_directory}
                            </span><br>
                            <span style="color: #333;">
                                📅 予定: ${schedule.schedule_time ? new Date(schedule.schedule_time).toLocaleString('ja-JP') : '即座'}
                            </span><br>
                            <span style="color: #666; font-size: 12px;">
                                🔄 繰り返し: ${schedule.schedule_type === 'once' ? '1回のみ' : 
                                    schedule.schedule_type === 'daily' ? '毎日' :
                                    schedule.schedule_type === 'weekly' ? '毎週' :
                                    schedule.schedule_type === 'monthly' ? '毎月' : schedule.schedule_type}
                            </span>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <button onclick="executeSchedule('${schedule.id}')" 
                                ${schedule.status === 'executing' ? 'disabled' : ''}
                                style="${schedule.status === 'executing' ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                ${schedule.status === 'executing' ? '実行中...' : '今すぐ実行'}
                            </button>
                            <button onclick="deleteSchedule('${schedule.id}')" class="danger">削除</button>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        // 履歴リスト更新
        function updateHistoryList(history) {
            const list = document.getElementById('history-list');
            console.log('📜 履歴リスト更新:', history ? history.length + '件' : '0件', history);
            
            if (!list) {
                console.error('❌ history-list要素が見つかりません');
                return;
            }
            
            // リストをクリア
            list.innerHTML = '';
            
            // 履歴がない場合
            if (!history || history.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">アップロード履歴がありません</div>';
                return;
            }
            
            // 履歴を新しい順に並べ替え
            const sortedHistory = [...history].sort((a, b) => {
                return new Date(b.uploaded_at) - new Date(a.uploaded_at);
            });
            
            // 履歴アイテムを作成
            sortedHistory.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                
                // ステータスアイコンと色の設定
                const statusIcon = (entry.status === 'success' || entry.status === 'completed') ? '✅' : '❌';
                const statusColor = (entry.status === 'success' || entry.status === 'completed') ? '#28a745' : '#dc3545';
                const statusText = (entry.status === 'success' || entry.status === 'completed') ? '成功' : '失敗';
                
                // ファイルサイズの表示
                const fileSize = entry.file_size ? `${(entry.file_size / 1024).toFixed(2)} KB` : '';
                
                // 実行時間の表示
                const duration = entry.duration_ms ? `${entry.duration_ms}ms` : '';
                
                // スケジュール実行フラグ
                const scheduleFlag = entry.schedule_executed ? '📅 ' : '';
                
                item.innerHTML = `
                    <div style="padding: 10px; border-left: 3px solid ${statusColor};">
                        <div style="display: flex; align-items: center; margin-bottom: 5px;">
                            ${statusIcon} 
                            <strong style="margin-left: 5px;">${scheduleFlag}${entry.file_name || 'Unknown'}</strong>
                        </div>
                        <div style="color: #666; font-size: 12px;">
                            <div>${entry.profile_name || 'Unknown'} - ${entry.upload_path || '/'}</div>
                            <div>${new Date(entry.uploaded_at).toLocaleString('ja-JP')}</div>
                            <div>
                                ${statusText}
                                ${fileSize ? ` • ${fileSize}` : ''}
                                ${duration ? ` • ${duration}` : ''}
                            </div>
                            ${entry.error_message ? `<div style="color: #dc3545;">エラー: ${entry.error_message}</div>` : ''}
                        </div>
                    </div>
                `;
                
                list.appendChild(item);
            });
        }
        
        // 統計更新
        function updateStats(stats) {
            const grid = document.getElementById('stats-grid');
            if (!grid) {
                console.log('⚠️ stats-gridが見つかりません');
                return;
            }
            
            // ファイルサイズを人間が読みやすい形式に変換
            function formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // 平均時間を計算
            const avgTime = stats.total > 0 ? Math.round((stats.totalDuration || 0) / stats.total / 1000) : 0;
            
            grid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total || 0}</div>
                    <div class="stat-label">総アップロード</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <div class="stat-value">${stats.success || 0}</div>
                    <div class="stat-label">成功</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    <div class="stat-value">${stats.failed || 0}</div>
                    <div class="stat-label">失敗</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <div class="stat-value">${avgTime}秒</div>
                    <div class="stat-label">平均時間</div>
                </div>
            `;
            
            // 追加の統計情報カードを作成
            const additionalStats = `
                <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                    <div class="stat-value">${formatBytes(stats.totalSize || 0)}</div>
                    <div class="stat-label">総容量</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
                    <div class="stat-value">${((stats.success || 0) / (stats.total || 1) * 100).toFixed(1)}%</div>
                    <div class="stat-label">成功率</div>
                </div>
            `;
            
            grid.innerHTML += additionalStats;
        }
        
        // アップロード実行
        async function executeUpload() {
            console.log('🚀 executeUpload関数が呼ばれました');
            const profileId = document.getElementById('upload-profile').value;
            const files = document.getElementById('file-input').files;
            const mode = document.getElementById('upload-mode').value;
            const directory = document.getElementById('upload-directory').value;
            
            console.log('📊 アップロード設定:', {
                profileId,
                filesCount: files.length,
                mode,
                directory
            });
            
            if (!profileId) {
                showToast('プロファイルを選択してください', 'error');
                return;
            }
            
            if (files.length === 0) {
                showToast('ファイルを選択してください', 'error');
                return;
            }
            
            if (mode === 'immediate') {
                console.log('📤 即座にアップロードモード');
                // 即座にアップロード
                for (const file of files) {
                    console.log('📁 ファイル処理中:', file.name);
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('profile_id', profileId);
                    formData.append('uploadDirectory', directory);
                    
                    try {
                        // プロファイル情報をformDataに追加
                        const profile = await getProfile(profileId);
                        if (profile) {
                            formData.append('host', profile.host);
                            formData.append('port', profile.port);
                            formData.append('username', profile.username);
                            formData.append('password', profile.password);
                            formData.append('protocol', profile.protocol || 'sftp');
                            formData.append('uploadPath', directory);
                        }
                        
                        console.log('🌐 APIリクエスト送信:', '/api/upload');
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            body: formData
                        });
                        console.log('📥 レスポンス受信:', response.status);
                        
                        const result = await response.json();
                        if (result.success) {
                            // 履歴に追加
                            const historyEntry = {
                                id: Date.now().toString(),
                                file_name: file.name,
                                profile_id: profileId,
                                profile_name: profile ? profile.name : 'Unknown',
                                upload_path: directory,
                                uploaded_at: new Date().toISOString(),
                                status: 'success',
                                file_size: file.size,
                                duration_ms: 0,
                                protocol: profile ? profile.protocol : 'unknown'
                            };
                            
                            // LocalStorageから既存の履歴を取得
                            const existingHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
                            existingHistory.unshift(historyEntry); // 新しい履歴を先頭に追加
                            
                            // 最大1000件まで保持
                            if (existingHistory.length > 1000) {
                                existingHistory.splice(1000);
                            }
                            
                            localStorage.setItem('uploadHistory', JSON.stringify(existingHistory));
                            
                            showToast(`${file.name} をアップロードしました`, 'success');
                        } else {
                            // 失敗も履歴に記録
                            const historyEntry = {
                                id: Date.now().toString(),
                                file_name: file.name,
                                profile_id: profileId,
                                profile_name: profile ? profile.name : 'Unknown',
                                upload_path: directory,
                                uploaded_at: new Date().toISOString(),
                                status: 'failed',
                                error_message: result.message || 'Upload failed',
                                file_size: file.size,
                                protocol: profile ? profile.protocol : 'unknown'
                            };
                            
                            const existingHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
                            existingHistory.unshift(historyEntry);
                            if (existingHistory.length > 1000) {
                                existingHistory.splice(1000);
                            }
                            localStorage.setItem('uploadHistory', JSON.stringify(existingHistory));
                            
                            showToast(`${file.name} のアップロード失敗: ${result.message}`, 'error');
                        }
                    } catch (error) {
                        showToast(`エラー: ${error.message}`, 'error');
                    }
                }
                
                // 履歴を更新
                await loadHistory();
                
            } else {
                console.log('📅 スケジュール予約モード');
                // スケジュール予約
                const scheduleTime = document.getElementById('schedule-time').value;
                const scheduleRepeat = document.getElementById('schedule-repeat').value;
                console.log('⏰ スケジュール設定:', { scheduleTime, scheduleRepeat });
                
                for (const file of files) {
                    // FormDataでファイル送信（Base64の問題を解決）
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('profile_id', profileId);
                    formData.append('name', file.name);
                    formData.append('upload_directory', directory);
                    formData.append('schedule_type', scheduleRepeat);
                    if (scheduleTime) {
                        formData.append('schedule_time', scheduleTime);
                    }
                    
                    try {
                        // スケジュール機能は一時的に保存で代替
                        const response = await fetch('/api/save-temp-file', {
                            method: 'POST',
                            body: formData
                        });
                            
                        const result = await response.json();
                        if (result.success) {
                            // LocalStorageにスケジュールを保存
                            const profile = await getProfile(profileId);
                            const newSchedule = {
                                id: Date.now().toString(),
                                name: file.name,
                                profile_id: profileId,
                                profile_name: profile ? profile.name : 'Unknown',
                                upload_directory: directory,
                                schedule_time: scheduleTime || null,
                                schedule_type: scheduleRepeat || 'once',
                                status: 'pending',
                                fileId: result.fileId,
                                created_at: new Date().toISOString()
                            };
                            
                            console.log('📝 新規スケジュール作成:', {
                                name: newSchedule.name,
                                schedule_time: newSchedule.schedule_time,
                                schedule_type: newSchedule.schedule_type,
                                実行予定: scheduleTime ? new Date(scheduleTime).toLocaleString() : '即座'
                            });
                            
                            // LocalStorageから既存のスケジュールを取得
                            const existingSchedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
                            console.log('📝 既存スケジュール:', existingSchedules.length + '件');
                            existingSchedules.push(newSchedule);
                            localStorage.setItem('scheduledUploads', JSON.stringify(existingSchedules));
                            console.log('💾 スケジュール保存完了:', existingSchedules.length + '件');
                            
                            showToast(`${file.name} をスケジュールに追加しました`, 'success');
                            await loadSchedules();
                        } else {
                            showToast(`スケジュール追加失敗: ${result.message}`, 'error');
                        }
                    } catch (error) {
                        showToast(`エラー: ${error.message}`, 'error');
                    }
                }
            }
        }
        
        // プロファイル保存（データベースへ）
        async function saveProfile() {
            const profile = {
                name: document.getElementById('profile-name').value,
                protocol: document.getElementById('profile-protocol').value,
                host: document.getElementById('profile-host').value,
                port: document.getElementById('profile-port').value,
                username: document.getElementById('profile-username').value,
                password: document.getElementById('profile-password').value,
                default_directory: document.getElementById('profile-directory').value
            };
            
            const modal = document.getElementById('profile-modal');
            const profileId = modal.dataset.profileId;
            const isEditing = !!profileId;
            
            try {
                let result;
                
                if (isEditing) {
                    // Update existing profile
                    // APIエンドポイントが存在しないためLocalStorageで更新
                    const profiles = JSON.parse(localStorage.getItem('profiles') || '[]');
                    const profileIndex = profiles.findIndex(p => p.id === profileId);
                    if (profileIndex !== -1) {
                        profiles[profileIndex] = { ...profile, id: profileId };
                        localStorage.setItem('profiles', JSON.stringify(profiles));
                    }
                    result = { success: true, profile: { ...profile, id: profileId } };
                } else {
                    // Create new profile
                    // APIエンドポイントが存在しないためLocalStorageに新規作成
                    const profiles = JSON.parse(localStorage.getItem('profiles') || '[]');
                    profile.id = Date.now().toString();
                    profiles.push(profile);
                    localStorage.setItem('profiles', JSON.stringify(profiles));
                    result = { success: true, profile: profile };
                }
                if (result.success) {
                    showToast(`プロファイルを${isEditing ? '更新' : '保存'}しました`, 'success');
                    closeProfileModal();
                    await loadProfiles();
                } else {
                    showToast(`エラー: ${result.message}`, 'error');
                }
            } catch (error) {
                showToast(`エラー: ${error.message}`, 'error');
            }
        }
        
        // スケジュール実行
        async function executeSchedule(scheduleId) {
            console.log('🚀 スケジュール実行:', scheduleId);
            
            // LocalStorageから最新のスケジュールを取得
            const schedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
            const schedule = schedules.find(s => s.id === scheduleId);
            if (!schedule) {
                console.error('❌ スケジュールが見つかりません:', scheduleId);
                if (window.showToast) {
                    window.showToast('スケジュールが見つかりません', 'error');
                }
                return;
            }
            
            try {
                // プロファイル情報を取得
                const profiles = JSON.parse(localStorage.getItem('profiles') || '[]');
                const profile = profiles.find(p => p.id === schedule.profile_id);
                if (!profile) {
                    console.error('❌ プロファイルが見つかりません:', schedule.profile_id);
                    if (window.showToast) {
                        window.showToast('プロファイルが見つかりません', 'error');
                    }
                    return;
                }
                
                // fileIdがある場合は新しい方式、fileDataがある場合は旧方式
                if (schedule.fileId) {
                    // 新しい方式: サーバーに保存されたファイルを使用
                    console.log('📁 fileIdを使用してアップロード:', schedule.fileId);
                    
                    const formData = new FormData();
                    formData.append('fileId', schedule.fileId);
                    formData.append('host', profile.host);
                    formData.append('port', profile.port);
                    formData.append('username', profile.username);
                    formData.append('password', profile.password);
                    formData.append('protocol', profile.protocol || 'sftp');
                    formData.append('uploadPath', schedule.upload_directory || '/');
                    
                    try {
                        const response = await fetch('/api/upload-temp-file', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                fileId: schedule.fileId,
                                host: profile.host,
                                port: profile.port,
                                username: profile.username,
                                password: profile.password,
                                protocol: profile.protocol || 'sftp',
                                uploadPath: schedule.upload_directory || '/'
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            showToast('スケジュール実行成功！', 'success');
                            
                            // 履歴に追加
                            const historyEntry = {
                                id: Date.now().toString(),
                                file_name: schedule.name || schedule.fileName,
                                profile_id: schedule.profile_id,
                                profile_name: profile.name || 'Unknown',
                                upload_path: schedule.upload_directory || '/',
                                uploaded_at: new Date().toISOString(),
                                status: 'success',
                                file_size: 0, // ファイルサイズは不明
                                duration_ms: 0,
                                protocol: profile.protocol || 'sftp',
                                schedule_executed: true
                            };
                            
                            // LocalStorageから既存の履歴を取得
                            const existingHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
                            existingHistory.unshift(historyEntry); // 新しい履歴を先頭に追加
                            
                            // 最大1000件まで保持
                            if (existingHistory.length > 1000) {
                                existingHistory.splice(1000);
                            }
                            
                            localStorage.setItem('uploadHistory', JSON.stringify(existingHistory));
                            
                            // スケジュールのステータスを更新
                            schedule.status = 'completed';
                            const schedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
                            const index = schedules.findIndex(s => s.id === scheduleId);
                            if (index !== -1) {
                                schedules[index] = schedule;
                                localStorage.setItem('scheduledUploads', JSON.stringify(schedules));
                            }
                            
                            // 履歴とスケジュールリストを更新
                            await loadSchedules();
                            await loadHistory();
                            await loadStats();  // 統計情報も更新
                        } else {
                            showToast(`スケジュール実行失敗: ${result.message}`, 'error');
                            
                            // 失敗も履歴に記録
                            const historyEntry = {
                                id: Date.now().toString(),
                                file_name: schedule.name || schedule.fileName,
                                profile_id: schedule.profile_id,
                                profile_name: profile.name || 'Unknown',
                                upload_path: schedule.upload_directory || '/',
                                uploaded_at: new Date().toISOString(),
                                status: 'failed',
                                error_message: result.message || 'Upload failed',
                                file_size: 0,
                                protocol: profile.protocol || 'sftp',
                                schedule_executed: true
                            };
                            
                            const existingHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
                            existingHistory.unshift(historyEntry);
                            if (existingHistory.length > 1000) {
                                existingHistory.splice(1000);
                            }
                            localStorage.setItem('uploadHistory', JSON.stringify(existingHistory));
                            
                            // 履歴を更新
                            await loadHistory();
                            await loadStats();
                        }
                    } catch (error) {
                        console.error('❌ アップロードエラー:', error);
                        showToast(`エラー: ${error.message}`, 'error');
                    }
                    return;
                }
                
                // 旧方式: Base64エンコードされたファイルデータを使用
                let fileData;
                try {
                    fileData = atob(schedule.fileData);
                } catch (e) {
                    console.error('❌ ファイルデータのデコードに失敗:', e);
                    if (window.showToast) {
                        window.showToast('ファイルデータが破損しています', 'error');
                    }
                    return;
                }
                
                // Blobを作成してFormDataに追加
                const blob = new Blob([fileData], { type: 'text/plain' });
                const file = new File([blob], schedule.fileName || schedule.name, { type: 'text/plain' });
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('profile_id', profile.id);
                formData.append('uploadDirectory', schedule.upload_directory || '/');
                
                if (window.showToast) {
                    window.showToast(`${schedule.name} をアップロード中...`, 'info');
                }
                
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('✅ スケジュール実行成功:', schedule.name);
                    if (window.showToast) {
                        window.showToast(`${schedule.name} のアップロードが成功しました`, 'success');
                    }
                    
                    // 履歴に追加（旧方式）
                    const historyEntry = {
                        id: Date.now().toString(),
                        file_name: schedule.fileName || schedule.name,
                        profile_id: schedule.profile_id,
                        profile_name: profile.name || 'Unknown',
                        upload_path: schedule.upload_directory || '/',
                        uploaded_at: new Date().toISOString(),
                        status: 'success',
                        file_size: 0, // Base64の場合、正確なサイズは不明
                        duration_ms: 0,
                        protocol: profile.protocol || 'unknown',
                        schedule_executed: true,
                        method: 'base64'
                    };
                    
                    // LocalStorageから既存の履歴を取得
                    const existingHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
                    existingHistory.unshift(historyEntry);
                    
                    // 最大1000件まで保持
                    if (existingHistory.length > 1000) {
                        existingHistory.splice(1000);
                    }
                    
                    localStorage.setItem('uploadHistory', JSON.stringify(existingHistory));
                    
                    // スケジュールを完了としてマーク（削除はしない）
                    schedule.status = 'completed';
                    schedule.completed_at = new Date().toISOString();
                    
                    // LocalStorageに保存
                    const updatedSchedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
                    const index = updatedSchedules.findIndex(s => s.id === scheduleId);
                    if (index !== -1) {
                        updatedSchedules[index] = schedule;
                        localStorage.setItem('scheduledUploads', JSON.stringify(updatedSchedules));
                    }
                    await loadSchedules();
                    await loadHistory();
                    await loadStats();
                    
                } else {
                    console.error('❌ スケジュール実行失敗:', result.message);
                    if (window.showToast) {
                        window.showToast(`${schedule.name} のアップロードに失敗: ${result.message}`, 'error');
                    }
                    
                    // 失敗も履歴に記録（旧方式）
                    const historyEntry = {
                        id: Date.now().toString(),
                        file_name: schedule.fileName || schedule.name,
                        profile_id: schedule.profile_id,
                        profile_name: profile.name || 'Unknown',
                        upload_path: schedule.upload_directory || '/',
                        uploaded_at: new Date().toISOString(),
                        status: 'failed',
                        error_message: result.message || 'Upload failed',
                        file_size: 0,
                        protocol: profile.protocol || 'unknown',
                        schedule_executed: true,
                        method: 'base64'
                    };
                    
                    const existingHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
                    existingHistory.unshift(historyEntry);
                    if (existingHistory.length > 1000) {
                        existingHistory.splice(1000);
                    }
                    localStorage.setItem('uploadHistory', JSON.stringify(existingHistory));
                    
                    schedule.status = 'failed';
                    schedule.error_message = result.message;
                    
                    // LocalStorageに保存
                    const updatedSchedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
                    const index = updatedSchedules.findIndex(s => s.id === scheduleId);
                    if (index !== -1) {
                        updatedSchedules[index] = schedule;
                        localStorage.setItem('scheduledUploads', JSON.stringify(updatedSchedules));
                    }
                    await loadSchedules();
                    await loadHistory();
                    await loadStats();
                }
                
                // 履歴と統計を更新
                await loadHistory();
                await loadStats();
                
            } catch (error) {
                console.error('❌ スケジュール実行エラー:', error);
                if (window.showToast) {
                    window.showToast(`エラー: ${error.message}`, 'error');
                }
                
                // エラーも履歴に記録
                const historyEntry = {
                    id: Date.now().toString(),
                    file_name: schedule.fileName || schedule.name || 'Unknown',
                    profile_id: schedule.profile_id,
                    profile_name: profile ? profile.name : 'Unknown',
                    upload_path: schedule.upload_directory || '/',
                    uploaded_at: new Date().toISOString(),
                    status: 'failed',
                    error_message: error.message || 'Unknown error',
                    file_size: 0,
                    protocol: profile ? profile.protocol : 'unknown',
                    schedule_executed: true
                };
                
                const existingHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
                existingHistory.unshift(historyEntry);
                if (existingHistory.length > 1000) {
                    existingHistory.splice(1000);
                }
                localStorage.setItem('uploadHistory', JSON.stringify(existingHistory));
                
                schedule.status = 'failed';
                schedule.error_message = error.message;
                
                // LocalStorageに保存
                const updatedSchedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
                const index = updatedSchedules.findIndex(s => s.id === scheduleId);
                if (index !== -1) {
                    updatedSchedules[index] = schedule;
                    localStorage.setItem('scheduledUploads', JSON.stringify(updatedSchedules));
                }
                await loadSchedules();
                await loadHistory();
                await loadStats();
            }
        }
        
        // プロファイル削除（データベースから）
        async function editProfile(profileId) {
            try {
                // APIエンドポイントが存在しないためLocalStorageから取得
                const profiles = JSON.parse(localStorage.getItem('profiles') || '[]');
                const profile = profiles.find(p => p.id === profileId);
                
                if (profile) {
                    // Fill the form with existing profile data
                    document.getElementById('profile-name').value = profile.name;
                    document.getElementById('profile-protocol').value = profile.protocol;
                    document.getElementById('profile-host').value = profile.host;
                    document.getElementById('profile-port').value = profile.port;
                    document.getElementById('profile-username').value = profile.username;
                    document.getElementById('profile-password').value = profile.password;
                    document.getElementById('profile-directory').value = profile.default_directory || '/';
                    
                    // Set the profile ID for updating instead of creating
                    document.getElementById('profile-modal').dataset.profileId = profileId;
                    
                    // Show the modal
                    showAddProfileModal();
                    
                    showToast('プロファイルを読み込みました', 'success');
                } else {
                    showToast('プロファイルの読み込みに失敗しました', 'error');
                }
            } catch (error) {
                showToast(`エラー: ${error.message}`, 'error');
            }
        }

        async function deleteProfile(profileId) {
            if (!confirm('このプロファイルを削除しますか？')) return;
            
            try {
                // APIエンドポイントが存在しないためLocalStorageから直接削除
                const profiles = JSON.parse(localStorage.getItem('profiles') || '[]');
                const updatedProfiles = profiles.filter(p => p.id !== profileId);
                localStorage.setItem('profiles', JSON.stringify(updatedProfiles));
                const result = { success: true };
                if (result.success) {
                    showToast('プロファイルを削除しました', 'success');
                    await loadProfiles();
                }
            } catch (error) {
                showToast(`エラー: ${error.message}`, 'error');
            }
        }
        
        // プロファイル取得ヘルパー関数
        async function getProfile(profileId) {
            const profiles = JSON.parse(localStorage.getItem('profiles') || '[]');
            return profiles.find(p => p.id === profileId) || null;
        }
        
        // スケジュール削除（データベースから）

        async function deleteSchedule(scheduleId) {
            if (!confirm('このスケジュールを削除しますか？')) return;
            
            console.log('🗑️ スケジュール削除:', scheduleId);
            
            try {
                // LocalStorageから削除
                const schedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
                const filteredSchedules = schedules.filter(s => s.id !== scheduleId);
                localStorage.setItem('scheduledUploads', JSON.stringify(filteredSchedules));
                
                showToast('スケジュールを削除しました', 'success');
                await loadSchedules();
            } catch (error) {
                showToast(`エラー: ${error.message}`, 'error');
            }
        }
        
        // 接続テスト
        async function testProfileConnection(profileId) {
            try {
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ profile_id: profileId })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('接続成功！', 'success');
                } else {
                    showToast(`接続失敗: ${result.message}`, 'error');
                }
                
                // 履歴を更新（接続テストも記録される）
                await loadHistory();
            } catch (error) {
                showToast(`エラー: ${error.message}`, 'error');
            }
        }
        
        // プロファイルモーダルでの接続テスト関数
        async function testConnection() {
            try {
                // フォームから接続情報を取得
                const connectionData = {
                    host: document.getElementById('profile-host').value,
                    port: parseInt(document.getElementById('profile-port').value) || 22,
                    username: document.getElementById('profile-username').value,
                    password: document.getElementById('profile-password').value,
                    protocol: document.getElementById('profile-protocol').value || 'sftp'
                };
                
                // デバッグ: 取得した値を確認
                console.log('接続テスト - 取得した値:', connectionData);
                
                // 必須フィールドのチェック
                if (!connectionData.host || !connectionData.username || !connectionData.password) {
                    console.log('必須フィールドチェック失敗:', {
                        host: connectionData.host,
                        username: connectionData.username,
                        password: connectionData.password ? '***' : 'empty'
                    });
                    showToast('ホスト、ユーザー名、パスワードは必須です', 'error');
                    return;
                }
                
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(connectionData)
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('接続テスト成功！', 'success');
                } else {
                    showToast(`接続テスト失敗: ${result.message}`, 'error');
                }
            } catch (error) {
                showToast(`接続テストエラー: ${error.message}`, 'error');
                console.error('Connection test error:', error);
            }
        }
        
        // UI関数
        function switchTab(tabName, element) {
            console.log('📑 タブ切り替え:', tabName);
            
            // Remove active from all tabs and content
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active to clicked tab
            if (element) {
                element.classList.add('active');
            } else {
                // Fallback: find the tab by tabName
                document.querySelector(`[onclick*="switchTab('${tabName}')"]`)?.classList.add('active');
            }
            
            // Add active to corresponding content
            const targetContent = document.getElementById(`${tabName}-tab`);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // タブごとにデータを読み込む
            switch(tabName) {
                case 'history':
                    console.log('📜 履歴タブを開きました');
                    loadHistory();
                    break;
                case 'stats':
                    console.log('📊 統計タブを開きました');
                    loadStats();
                    break;
                case 'profiles':
                    console.log('👤 プロファイルタブを開きました');
                    loadProfiles();
                    break;
                case 'schedule':
                    console.log('📅 スケジュールタブを開きました');
                    loadSchedules();
                    break;
            }
        }
        
        function showAddProfileModal() {
            document.getElementById('profile-modal').style.display = 'block';
        }
        
        function closeProfileModal() {
            const modal = document.getElementById('profile-modal');
            modal.style.display = 'none';
            
            // Clear form and editing state
            document.getElementById('profile-name').value = '';
            document.getElementById('profile-protocol').value = 'ftp';
            document.getElementById('profile-host').value = '';
            document.getElementById('profile-port').value = '21';
            document.getElementById('profile-username').value = '';
            document.getElementById('profile-password').value = '';
            document.getElementById('profile-directory').value = '/';
            delete modal.dataset.profileId;
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.style.background = type === 'success' ? '#28a745' : 
                                    type === 'error' ? '#dc3545' : '#17a2b8';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // アップロードモード変更
        document.getElementById('upload-mode').addEventListener('change', (e) => {
            document.getElementById('schedule-options').style.display = 
                e.target.value === 'schedule' ? 'block' : 'none';
        });
        
        // プロトコル変更時のポート自動設定
        document.getElementById('profile-protocol').addEventListener('change', (e) => {
            document.getElementById('profile-port').value = e.target.value === 'sftp' ? '22' : '21';
        });
        
        // ページロード時の初期化
        window.addEventListener('load', initialize);
        
        // ========== ドラッグ&ドロップファイル選択機能 ==========
        
        // ドラッグ&ドロップ機能の初期化
        function initializeDragAndDrop() {
            const dropZone = document.getElementById('file-drop-zone');
            const fileInput = document.getElementById('file-input');
            
            if (!dropZone || !fileInput) {
                console.error('❌ ドロップゾーンまたはファイル入力が見つかりません');
                return;
            }
            
            console.log('✅ ドラッグ&ドロップ機能を初期化しました');
            
            // ドラッグオーバー時のスタイル
            const dragOverStyle = {
                'border-color': '#007bff',
                'background-color': '#e3f2fd',
                'transform': 'scale(1.02)'
            };
            
            const normalStyle = {
                'border-color': '#ddd',
                'background-color': '#f9f9f9',
                'transform': 'scale(1)'
            };
            
            // ドラッグ関連イベント
            dropZone.addEventListener('dragenter', handleDragEnter);
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('dragleave', handleDragLeave);
            dropZone.addEventListener('drop', handleDrop);
            
            // ファイル選択時の処理
            fileInput.addEventListener('change', handleFileSelect);
            
            function handleDragEnter(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('🎯 ドラッグエンター');
                applyDragOverStyle();
                updateDropZoneContent('ファイルをここにドロップ！', '📥', '#007bff');
            }
            
            function handleDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'copy';
            }
            
            function handleDragLeave(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // ドロップゾーン外に完全に出た場合のみスタイルをリセット
                const rect = dropZone.getBoundingClientRect();
                if (e.clientX < rect.left || e.clientX > rect.right || 
                    e.clientY < rect.top || e.clientY > rect.bottom) {
                    console.log('🚪 ドラッグリーブ');
                    applyNormalStyle();
                    resetDropZoneContent();
                }
            }
            
            function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('📂 ファイルドロップ！');
                
                applyNormalStyle();
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    console.log(`✅ ${files.length}個のファイルをドロップしました`);
                    
                    // FileListをfile inputに設定
                    fileInput.files = files;
                    
                    // ファイル選択処理を実行
                    handleFileSelect({ target: { files: files } });
                    
                    if (window.showToast) {
                        window.showToast(`${files.length}個のファイルを選択しました`, 'success');
                    }
                } else {
                    console.warn('⚠️ ドロップされたファイルがありません');
                    if (window.showToast) {
                        window.showToast('有効なファイルがドロップされませんでした', 'error');
                    }
                }
            }
            
            function handleFileSelect(e) {
                const files = e.target.files;
                if (files.length === 0) {
                    resetDropZoneContent();
                    return;
                }
                
                console.log(`📁 ${files.length}個のファイルが選択されました`);
                displaySelectedFiles(files);
            }
            
            // スタイル適用関数
            function applyDragOverStyle() {
                Object.assign(dropZone.style, dragOverStyle);
            }
            
            function applyNormalStyle() {
                Object.assign(dropZone.style, normalStyle);
            }
            
            // ドロップゾーンのコンテンツを更新
            function updateDropZoneContent(text, icon, color) {
                const content = document.getElementById('drop-zone-content');
                if (content) {
                    content.innerHTML = `
                        <div style="font-size: 48px; color: ${color}; margin-bottom: 10px;">${icon}</div>
                        <div style="font-size: 16px; color: ${color}; margin-bottom: 5px;">
                            <strong>${text}</strong>
                        </div>
                    `;
                }
            }
            
            function resetDropZoneContent() {
                const content = document.getElementById('drop-zone-content');
                const display = document.getElementById('selected-files-display');
                
                if (content) {
                    content.innerHTML = `
                        <div style="font-size: 48px; color: #999; margin-bottom: 10px;">📁</div>
                        <div style="font-size: 16px; color: #666; margin-bottom: 5px;">
                            <strong>ファイルをドラッグ&ドロップ</strong>
                        </div>
                        <div style="font-size: 14px; color: #999;">
                            または <span style="color: #007bff; text-decoration: underline;">クリックして選択</span>
                        </div>
                    `;
                }
                
                if (display) {
                    display.style.display = 'none';
                    display.innerHTML = '';
                }
            }
            
            // 選択されたファイルを表示
            function displaySelectedFiles(files) {
                const display = document.getElementById('selected-files-display');
                const content = document.getElementById('drop-zone-content');
                
                if (!display || !content) return;
                
                // メインコンテンツを更新
                content.innerHTML = `
                    <div style="font-size: 32px; color: #28a745; margin-bottom: 10px;">✅</div>
                    <div style="font-size: 16px; color: #28a745; margin-bottom: 5px;">
                        <strong>${files.length}個のファイルを選択済み</strong>
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        クリックして変更可能
                    </div>
                `;
                
                // ファイルリストを表示
                let fileListHTML = '<div style="text-align: left; max-height: 150px; overflow-y: auto;">';
                
                Array.from(files).forEach((file, index) => {
                    const size = (file.size / 1024).toFixed(2);
                    const icon = getFileIcon(file.name);
                    
                    fileListHTML += `
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 8px;
                            border-bottom: 1px solid #eee;
                            background: #fff;
                            border-radius: 4px;
                            margin-bottom: 4px;
                        ">
                            <div style="display: flex; align-items: center;">
                                <span style="margin-right: 8px;">${icon}</span>
                                <div>
                                    <div style="font-weight: bold; color: #333;">${file.name}</div>
                                    <div style="font-size: 12px; color: #666;">${size} KB</div>
                                </div>
                            </div>
                            <button onclick="removeFile(${index})" style="
                                background: #dc3545;
                                color: white;
                                border: none;
                                padding: 4px 8px;
                                border-radius: 3px;
                                cursor: pointer;
                                font-size: 12px;
                            ">✖</button>
                        </div>
                    `;
                });
                
                fileListHTML += '</div>';
                
                display.innerHTML = fileListHTML;
                display.style.display = 'block';
            }
            
            // ファイル拡張子からアイコンを取得
            function getFileIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const iconMap = {
                    'csv': '📊',
                    'txt': '📄',
                    'xml': '🏷️',
                    'html': '🌐',
                    'zip': '📦',
                    'pdf': '📕',
                    'jpg': '🖼️',
                    'jpeg': '🖼️',
                    'png': '🖼️',
                    'gif': '🖼️',
                    'doc': '📝',
                    'docx': '📝',
                    'xls': '📈',
                    'xlsx': '📈'
                };
                
                return iconMap[ext] || '📄';
            }
        }
        
        // ファイルを削除（リストから）
        function removeFile(index) {
            const fileInput = document.getElementById('file-input');
            if (!fileInput || !fileInput.files) return;
            
            // FileListは読み取り専用なので、新しいDataTransferを作成
            const dt = new DataTransfer();
            const files = Array.from(fileInput.files);
            
            files.forEach((file, i) => {
                if (i !== index) {
                    dt.items.add(file);
                }
            });
            
            fileInput.files = dt.files;
            
            // 表示を更新
            if (dt.files.length === 0) {
                resetDropZoneContent();
            } else {
                displaySelectedFiles(dt.files);
            }
            
            if (window.showToast) {
                window.showToast('ファイルを削除しました', 'info');
            }
            
            function resetDropZoneContent() {
                const content = document.getElementById('drop-zone-content');
                const display = document.getElementById('selected-files-display');
                
                if (content) {
                    content.innerHTML = `
                        <div style="font-size: 48px; color: #999; margin-bottom: 10px;">📁</div>
                        <div style="font-size: 16px; color: #666; margin-bottom: 5px;">
                            <strong>ファイルをドラッグ&ドロップ</strong>
                        </div>
                        <div style="font-size: 14px; color: #999;">
                            または <span style="color: #007bff; text-decoration: underline;">クリックして選択</span>
                        </div>
                    `;
                }
                
                if (display) {
                    display.style.display = 'none';
                    display.innerHTML = '';
                }
            }
            
            function displaySelectedFiles(files) {
                const display = document.getElementById('selected-files-display');
                const content = document.getElementById('drop-zone-content');
                
                if (!display || !content) return;
                
                // メインコンテンツを更新
                content.innerHTML = `
                    <div style="font-size: 32px; color: #28a745; margin-bottom: 10px;">✅</div>
                    <div style="font-size: 16px; color: #28a745; margin-bottom: 5px;">
                        <strong>${files.length}個のファイルを選択済み</strong>
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        クリックして変更可能
                    </div>
                `;
                
                // ファイルリストを表示（同じ実装）
                let fileListHTML = '<div style="text-align: left; max-height: 150px; overflow-y: auto;">';
                
                Array.from(files).forEach((file, index) => {
                    const size = (file.size / 1024).toFixed(2);
                    const icon = getFileIcon(file.name);
                    
                    fileListHTML += `
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 8px;
                            border-bottom: 1px solid #eee;
                            background: #fff;
                            border-radius: 4px;
                            margin-bottom: 4px;
                        ">
                            <div style="display: flex; align-items: center;">
                                <span style="margin-right: 8px;">${icon}</span>
                                <div>
                                    <div style="font-weight: bold; color: #333;">${file.name}</div>
                                    <div style="font-size: 12px; color: #666;">${size} KB</div>
                                </div>
                            </div>
                            <button onclick="removeFile(${index})" style="
                                background: #dc3545;
                                color: white;
                                border: none;
                                padding: 4px 8px;
                                border-radius: 3px;
                                cursor: pointer;
                                font-size: 12px;
                            ">✖</button>
                        </div>
                    `;
                });
                
                fileListHTML += '</div>';
                
                display.innerHTML = fileListHTML;
                display.style.display = 'block';
            }
            
            function getFileIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const iconMap = {
                    'csv': '📊',
                    'txt': '📄',
                    'xml': '🏷️',
                    'html': '🌐',
                    'zip': '📦',
                    'pdf': '📕',
                    'jpg': '🖼️',
                    'jpeg': '🖼️',
                    'png': '🖼️',
                    'gif': '🖼️',
                    'doc': '📝',
                    'docx': '📝',
                    'xls': '📈',
                    'xlsx': '📈'
                };
                
                return iconMap[ext] || '📄';
            }
        }
        
        // 初期化にドラッグ&ドロップを追加
        setTimeout(() => {
            initializeDragAndDrop();
        }, 500);
        // ========== サーバー選択同期修正 ==========
        // プロファイル選択を完全同期する関数
        window.syncProfileSelection = function(profileId) {
            console.log(`🔄 プロファイル同期: ${profileId}`);
            
            if (!profileId) {
                console.log('プロファイルIDが空です');
                // 最初の有効なプロファイルを選択
                const uploadSelect = document.getElementById('upload-profile');
                if (uploadSelect && uploadSelect.options.length > 1) {
                    uploadSelect.selectedIndex = 1;
                    profileId = uploadSelect.value;
                    console.log('💡 最初のプロファイルを自動選択:', profileId);
                } else {
                    return;
                }
            }
            
            try {
                // LocalStorageからプロファイルを取得
                const profilesData = localStorage.getItem('profiles');
                if (!profilesData) {
                    console.error('❌ プロファイルデータが見つかりません');
                    console.log('💡 プロファイル管理タブで新しいプロファイルを作成してください');
                    return;
                }
                
                const profiles = JSON.parse(profilesData);
                let profile = profiles.find(p => p.id === profileId || p.id === String(profileId) || String(p.id) === String(profileId));
                
                if (!profile) {
                    console.error(`❌ プロファイルが見つかりません: ${profileId}`);
                    console.log('📊 利用可能なプロファイル:');
                    profiles.forEach(p => console.log(`- ${p.name || p.host} (ID: ${p.id})`));
                    
                    // 代替として最初のプロファイルを使用
                    if (profiles.length > 0) {
                        profile = profiles[0];
                        console.log(`💡 代替プロファイルを使用: ${profile.name || profile.host}`);
                        
                        // select要素も更新
                        const uploadSelect = document.getElementById('upload-profile');
                        if (uploadSelect) {
                            uploadSelect.value = profile.id;
                        }
                    } else {
                        console.error('❌ 利用可能なプロファイルがありません');
                        return;
                    }
                }
                
                console.log('✅ プロファイル詳細:', profile);
                window.currentSelectedProfile = profile;
                
                // すべてのUI要素を更新
                updateAllUIElements(profile);
                
                // LocalStorageに保存
                localStorage.setItem('lastSelectedProfileId', profile.id);
                localStorage.setItem('currentProfile', JSON.stringify(profile));
                
                // 成功通知
                if (window.showToast) {
                    window.showToast(`${profile.name || profile.host}を選択しました`, 'success');
                }
                
            } catch (error) {
                console.error('❌ プロファイル同期エラー:', error);
                if (window.showToast) {
                    window.showToast('プロファイル同期エラーが発生しました', 'error');
                }
            }
        };

        // すべてのUI要素を更新
        function updateAllUIElements(profile) {
            console.log('📝 全UI要素を更新中...');
            
            // アップロードセクションのプロファイル選択
            const uploadSelect = document.getElementById('upload-profile');
            if (uploadSelect) {
                uploadSelect.value = profile.id;
            }
            
            // アップロードディレクトリフィールド
            const uploadDir = document.getElementById('upload-directory');
            if (uploadDir) {
                uploadDir.value = profile.default_directory || '/';
            }
            
            // カスタムイベントを発火
            const event = new CustomEvent('profileChanged', { 
                detail: profile 
            });
            document.dispatchEvent(event);
            
            console.log('✅ すべてのUI要素を更新完了');
        }

        // プロファイル選択イベントを拡張
        const originalUploadSelectChange = document.getElementById('upload-profile');
        if (originalUploadSelectChange) {
            originalUploadSelectChange.addEventListener('change', function() {
                const profileId = this.value;
                if (profileId) {
                    syncProfileSelection(profileId);
                    if (window.showToast && window.currentSelectedProfile) {
                        const profile = window.currentSelectedProfile;
                        window.showToast(`${profile.name || profile.host}を選択しました`, 'success');
                    }
                }
            });
        }

        // ========== ディレクトリ保存機能修正 ==========
        // ディレクトリ変更を自動保存
        window.setupDirectorySaveHandler = function() {
            const uploadDirField = document.getElementById('upload-directory');
            if (!uploadDirField) return;
            
            let saveTimer = null;
            
            // 入力時の自動保存（1秒デバウンス）
            uploadDirField.addEventListener('input', function() {
                const newPath = this.value;
                clearTimeout(saveTimer);
                saveTimer = setTimeout(() => {
                    saveDirectoryToDatabase(newPath);
                }, 1000);
            });
            
            // フォーカスアウト時の即座保存
            uploadDirField.addEventListener('blur', function() {
                const newPath = this.value;
                clearTimeout(saveTimer);
                saveDirectoryToDatabase(newPath);
            });
            
            // Enterキーでの保存
            uploadDirField.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const newPath = this.value;
                    clearTimeout(saveTimer);
                    saveDirectoryToDatabase(newPath);
                }
            });
        };

        // データベースにディレクトリを保存 (LocalStorage版)
        function saveDirectoryToDatabase(directoryPath) {
            console.log('💾 ディレクトリをLocalStorageに保存:', directoryPath);
            
            const uploadSelect = document.getElementById('upload-profile');
            if (!uploadSelect || !uploadSelect.value) {
                console.warn('⚠️ プロファイルが選択されていません');
                return;
            }
            
            const profileId = uploadSelect.value;
            
            try {
                // LocalStorageからプロファイルデータを取得
                const profilesData = localStorage.getItem('profiles');
                if (!profilesData) {
                    console.error('プロファイルデータが見つかりません');
                    return;
                }
                
                const profiles = JSON.parse(profilesData);
                const profileIndex = profiles.findIndex(p => p.id === profileId);
                
                if (profileIndex === -1) {
                    console.error('プロファイルが見つかりません');
                    return;
                }
                
                // プロファイルを更新
                profiles[profileIndex].defaultDirectory = directoryPath;
                
                // LocalStorageに保存
                localStorage.setItem('profiles', JSON.stringify(profiles));
                
                // グローバル変数も更新
                if (window.currentSelectedProfile) {
                    window.currentSelectedProfile.defaultDirectory = directoryPath;
                    window.currentSelectedProfile.default_directory = directoryPath; // 互換性
                }
                
                console.log('✅ ディレクトリをLocalStorageに保存しました:', directoryPath);
                
                if (window.showToast) {
                    window.showToast('ディレクトリを保存しました', 'success');
                }
                
            } catch (error) {
                console.error('❌ LocalStorage更新エラー:', error);
                if (window.showToast) {
                    window.showToast('エラーが発生しました', 'error');
                }
            }
        }

        // 初期化時に実行
        setTimeout(() => {
            setupDirectorySaveHandler();
            
            // 最後に選択されたプロファイルを復元
            const lastProfileId = localStorage.getItem('lastSelectedProfileId');
            if (lastProfileId) {
                syncProfileSelection(lastProfileId);
            }
        }, 1000);

        // ========== 視覚的ディレクトリ参照機能 ==========
        
        // プロファイル作成時のディレクトリ参照機能
        window.browseProfileDirectory = async function() {
            console.log('📁 プロファイル作成時ディレクトリ参照ボタンがクリックされました');
            
            // プロファイルモーダルの入力値を取得
            const host = document.getElementById('profile-host').value;
            const port = document.getElementById('profile-port').value;
            const username = document.getElementById('profile-username').value;
            const password = document.getElementById('profile-password').value;
            const protocol = document.getElementById('profile-protocol').value;
            
            // 必須フィールドの確認
            if (!host || !username || !password) {
                if (window.showToast) {
                    window.showToast('先にホスト、ユーザー名、パスワードを入力してください', 'error');
                }
                alert('先にホスト、ユーザー名、パスワードを入力してください');
                return;
            }
            
            // 一時プロファイルを作成
            const tempProfile = {
                host: host,
                port: parseInt(port),
                username: username,
                password: password,
                protocol: protocol
            };
            
            // 接続テストを実行
            try {
                console.log('🔄 接続テスト中...', tempProfile);
                if (window.showToast) {
                    window.showToast('接続テスト中...', 'info');
                }
                
                // フロントエンド側でもタイムアウト設定 (30秒) - cURLテストでは4秒かかるため余裕を持たせる
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log('⏰ フロントエンドタイムアウト発生 (30秒)');
                    controller.abort('Connection timeout after 30 seconds');
                }, 30000);
                
                console.log('📡 API呼び出し開始...');
                
                let response;
                try {
                    response = await fetch('/api/test-connection', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(tempProfile),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    console.log('📥 レスポンス受信成功:', response.status, response.statusText);
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    console.error('📡 Fetch エラー:', fetchError);
                    throw fetchError;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                let result;
                try {
                    result = await response.json();
                    console.log('📊 レスポンスデータ解析成功:', result);
                } catch (jsonError) {
                    console.error('📊 JSON解析エラー:', jsonError);
                    throw new Error('サーバーからの応答を解析できませんでした');
                }
                
                if (!result.success) {
                    if (window.showToast) {
                        window.showToast(`接続失敗: ${result.message}`, 'error');
                    }
                    alert(`接続に失敗しました: ${result.message}`);
                    return;
                }
                
                console.log('✅ 接続成功！ディレクトリブラウザを開きます');
                if (window.showToast) {
                    window.showToast('接続成功！ディレクトリを選択してください', 'success');
                }
                
                // 成功時の処理を即座に実行
                setTimeout(() => {
                    console.log('🚀 ディレクトリブラウザ表示処理開始...');
                    proceedWithDirectoryBrowser();
                }, 100);
                
            } catch (error) {
                console.error('❌ 接続エラー:', error);
                let errorMessage = error.message;
                
                if (error.name === 'AbortError') {
                    errorMessage = 'タイムアウト: サーバーからの応答が15秒以内に完了しませんでした';
                    console.log('🔍 AbortError詳細:', {
                        name: error.name,
                        message: error.message,
                        reason: error.reason || 'no reason provided'
                    });
                } else if (error.message && error.message.includes('fetch')) {
                    errorMessage = 'ネットワークエラー: サーバーに接続できませんでした';
                }
                
                if (window.showToast) {
                    window.showToast(`接続エラー: ${errorMessage}`, 'error');
                }
                alert(`接続エラー: ${errorMessage}`);
                return;
            }
            
            // プロファイル情報を設定
            window.currentSelectedProfile = tempProfile;
            
            // ディレクトリブラウザ処理を別関数で実行
            function proceedWithDirectoryBrowser() {
                console.log('🚀 ディレクトリブラウザモーダルを作成中...');
                createProfileDirectoryBrowserModal();
                
                // 初期ディレクトリを設定（プロファイルモーダルの値または'/'）
                const currentDir = document.getElementById('profile-directory').value || '/';
                window.currentBrowsingPath = currentDir;
                console.log('📂 初期ディレクトリ設定:', currentDir);
                
                // モーダルを表示
                const modal = document.getElementById('profileDirectoryBrowserModal');
                console.log('🔍 モーダル要素:', modal);
                if (modal) {
                    modal.style.display = 'block';
                    console.log('✅ モーダルを表示しました');
                    
                    // パス表示を更新
                    const pathEl = document.getElementById('currentProfileBrowsePath');
                    if (pathEl) pathEl.textContent = currentDir;
                    
                    const inputEl = document.getElementById('selectedProfileDirectoryPath');
                    if (inputEl) inputEl.value = currentDir;
                    
                    // ディレクトリ内容を読み込む
                    console.log('📁 ディレクトリ内容を読み込み開始...');
                    loadProfileDirectoryContents(currentDir).catch(err => {
                        console.error('❌ ディレクトリ読み込みエラー:', err);
                        if (window.showToast) {
                            window.showToast('ディレクトリの読み込みに失敗しました', 'error');
                        }
                    });
                } else {
                    console.error('❌ モーダル要素が見つかりません');
                    if (window.showToast) {
                        window.showToast('ディレクトリブラウザの表示に失敗しました', 'error');
                    }
                }
            }
        };
        
        window.browseServerDirectory = async function() {
            console.log('📁 視覚的ディレクトリ参照ボタンがクリックされました');
            
            // 現在選択されているプロファイルを確認
            if (!window.currentSelectedProfile) {
                if (window.showToast) {
                    window.showToast('先にプロファイルを選択してください', 'error');
                }
                alert('先にプロファイルを選択してください');
                return;
            }
            
            // ディレクトリブラウザモーダルを作成・表示
            createDirectoryBrowserModal();
            
            // 初期ディレクトリを設定
            const currentDir = document.getElementById('upload-directory').value || 
                              window.currentSelectedProfile.defaultDirectory || 
                              window.currentSelectedProfile.default_directory || 
                              '/';
            
            window.currentBrowsingPath = currentDir;
            
            // モーダルを表示
            const modal = document.getElementById('directoryBrowserModal');
            if (modal) {
                modal.style.display = 'block';
                
                // パス表示を更新
                const pathEl = document.getElementById('currentBrowsePath');
                if (pathEl) pathEl.textContent = currentDir;
                
                const inputEl = document.getElementById('selectedDirectoryPath');
                if (inputEl) inputEl.value = currentDir;
                
                // ディレクトリ内容を読み込む
                await loadDirectoryContents(currentDir);
            }
        };

        // ディレクトリブラウザモーダルを作成
        function createDirectoryBrowserModal() {
            // 既存のモーダルを削除
            const existingModal = document.getElementById('directoryBrowserModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 新しいモーダルを作成
            const modal = document.createElement('div');
            modal.id = 'directoryBrowserModal';
            modal.style.cssText = `
                display: none;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.4);
            `;
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.cssText = `
                background-color: #fefefe;
                margin: 5% auto;
                padding: 20px;
                border: 1px solid #888;
                width: 80%;
                max-width: 600px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            `;
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">📁 ディレクトリを選択</h2>
                    <span onclick="closeDirectoryBrowserModal()" style="
                        font-size: 28px;
                        font-weight: bold;
                        cursor: pointer;
                        color: #aaa;
                    ">&times;</span>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>現在のパス:</strong> 
                    <span id="currentBrowsePath" style="font-family: monospace; color: #007bff;">/</span>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>選択されたパス:</label>
                    <input type="text" id="selectedDirectoryPath" value="/" style="
                        width: 100%;
                        padding: 8px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        font-family: monospace;
                    ">
                </div>
                
                <div id="directoryLoading" style="display:none; text-align:center; padding:20px;">
                    <div>🔄 読み込み中...</div>
                </div>
                
                <div id="directoryList" style="
                    border: 1px solid #ddd;
                    height: 300px;
                    overflow-y: auto;
                    background: #f9f9f9;
                    border-radius: 4px;
                    padding: 10px;
                ">
                    <div style="text-align: center; color: #999;">ディレクトリを読み込み中...</div>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button onclick="confirmDirectorySelection()" style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                        margin-right: 10px;
                    ">✅ 選択</button>
                    <button onclick="closeDirectoryBrowserModal()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                    ">❌ キャンセル</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        // ディレクトリ内容を読み込む
        async function loadDirectoryContents(path) {
            console.log('📂 ディレクトリを読み込み:', path);
            
            const profile = window.currentSelectedProfile;
            if (!profile) {
                console.error('❌ プロファイルが設定されていません');
                return;
            }
            
            const loadingEl = document.getElementById('directoryLoading');
            const listEl = document.getElementById('directoryList');
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (listEl) listEl.innerHTML = '';
            
            try {
                const response = await fetch('/api/browse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        host: profile.host,
                        port: parseInt(profile.port),
                        username: profile.username,
                        password: profile.password,
                        protocol: profile.protocol,
                        path: path || '/'
                    })
                });
                
                const data = await response.json();
                console.log('📥 レスポンス:', data);
                
                if (loadingEl) loadingEl.style.display = 'none';
                
                if (data.success) {
                    window.currentBrowsingPath = path;
                    
                    // パス表示を更新
                    const pathEl = document.getElementById('currentBrowsePath');
                    if (pathEl) pathEl.textContent = path;
                    
                    const files = data.files || [];
                    if (listEl) {
                        let html = '';
                        
                        // 親ディレクトリへのリンク
                        if (path !== '/') {
                            html += `
                                <div style="cursor:pointer; padding:8px; border-bottom:1px solid #eee; background:#fff; border-radius:4px; margin-bottom:2px;" 
                                     onclick="navigateToParentDirectory()">
                                    <span style="color:#007bff;">📁 ..</span>
                                </div>
                            `;
                        }
                        
                        // ディレクトリ
                        files.filter(f => f.type === 'directory').forEach(file => {
                            html += `
                                <div style="cursor:pointer; padding:8px; border-bottom:1px solid #eee; background:#fff; border-radius:4px; margin-bottom:2px;" 
                                     onclick="navigateToDirectory('${file.name}')">
                                    <span style="color:#007bff;">📁 ${file.name}</span>
                                </div>
                            `;
                        });
                        
                        // ファイル（表示のみ）
                        files.filter(f => f.type === 'file').forEach(file => {
                            const size = file.size ? `(${(file.size/1024).toFixed(2)} KB)` : '';
                            html += `
                                <div style="padding:8px; border-bottom:1px solid #eee; color:#666; background:#f9f9f9; border-radius:4px; margin-bottom:2px;">
                                    📄 ${file.name} <small>${size}</small>
                                </div>
                            `;
                        });
                        
                        listEl.innerHTML = html || '<div style="text-align:center; color:#999;">ディレクトリは空です</div>';
                    }
                } else {
                    console.error('❌ 参照失敗:', data.message);
                    if (listEl) {
                        listEl.innerHTML = `<div style="color:red; padding:10px;">エラー: ${data.message}</div>`;
                    }
                }
            } catch (error) {
                console.error('❌ 通信エラー:', error);
                if (loadingEl) loadingEl.style.display = 'none';
                if (listEl) {
                    listEl.innerHTML = `<div style="color:red; padding:10px;">通信エラー: ${error.message}</div>`;
                }
            }
        }

        // ナビゲーション関数
        function navigateToDirectory(dirname) {
            const newPath = window.currentBrowsingPath === '/' 
                ? `/${dirname}` 
                : `${window.currentBrowsingPath}/${dirname}`;
            console.log('➡️ ディレクトリに移動:', newPath);
            
            // 選択パスも更新
            const inputEl = document.getElementById('selectedDirectoryPath');
            if (inputEl) inputEl.value = newPath;
            
            loadDirectoryContents(newPath);
        }

        function navigateToParentDirectory() {
            const parts = window.currentBrowsingPath.split('/').filter(p => p);
            parts.pop();
            const newPath = parts.length > 0 ? '/' + parts.join('/') : '/';
            console.log('⬆️ 親ディレクトリに移動:', newPath);
            
            // 選択パスも更新
            const inputEl = document.getElementById('selectedDirectoryPath');
            if (inputEl) inputEl.value = newPath;
            
            loadDirectoryContents(newPath);
        }

        // モーダルを閉じる
        function closeDirectoryBrowserModal() {
            const modal = document.getElementById('directoryBrowserModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ディレクトリ選択を確認
        function confirmDirectorySelection() {
            const selectedPath = document.getElementById('selectedDirectoryPath').value || '/';
            const uploadDir = document.getElementById('upload-directory');
            
            console.log('✅ ディレクトリを選択:', selectedPath);
            
            // アップロードディレクトリを更新
            if (uploadDir) {
                uploadDir.value = selectedPath;
            }
            
            // プロファイルに保存
            if (window.currentSelectedProfile) {
                window.currentSelectedProfile.defaultDirectory = selectedPath;
                window.currentSelectedProfile.default_directory = selectedPath; // 互換性
                
                // プロファイルリストを更新
                const profilesData = localStorage.getItem('profiles');
                if (profilesData) {
                    try {
                        const profiles = JSON.parse(profilesData);
                        const profileIndex = profiles.findIndex(p => 
                            p.id === window.currentSelectedProfile.id || 
                            String(p.id) === String(window.currentSelectedProfile.id)
                        );
                        
                        if (profileIndex !== -1) {
                            profiles[profileIndex].defaultDirectory = selectedPath;
                            localStorage.setItem('profiles', JSON.stringify(profiles));
                            console.log('✅ プロファイルのディレクトリを保存しました');
                        }
                    } catch (error) {
                        console.error('❌ プロファイル保存エラー:', error);
                    }
                }
            }
            
            // 通知
            if (window.showToast) {
                window.showToast(`ディレクトリを ${selectedPath} に設定しました`, 'success');
            }
            
            closeDirectoryBrowserModal();
        }
        
        // ========== プロファイル作成専用ディレクトリブラウザ ==========
        
        // プロファイル作成専用ディレクトリブラウザモーダルを作成
        function createProfileDirectoryBrowserModal() {
            // 既存のモーダルを削除
            const existingModal = document.getElementById('profileDirectoryBrowserModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 新しいモーダルを作成
            const modal = document.createElement('div');
            modal.id = 'profileDirectoryBrowserModal';
            modal.style.cssText = `
                display: none;
                position: fixed;
                z-index: 10001;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
            `;
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.cssText = `
                background-color: #fefefe;
                margin: 5% auto;
                padding: 20px;
                border: 1px solid #888;
                width: 80%;
                max-width: 600px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            `;
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">📁 デフォルトディレクトリを選択</h2>
                    <span onclick="closeProfileDirectoryBrowserModal()" style="
                        font-size: 28px;
                        font-weight: bold;
                        cursor: pointer;
                        color: #aaa;
                    ">&times;</span>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>現在のパス:</strong> 
                    <span id="currentProfileBrowsePath" style="font-family: monospace; color: #007bff;">/</span>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>選択されたパス:</label>
                    <input type="text" id="selectedProfileDirectoryPath" value="/" style="
                        width: 100%;
                        padding: 8px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        font-family: monospace;
                    ">
                </div>
                
                <div id="profileDirectoryLoading" style="display:none; text-align:center; padding:20px;">
                    <div>🔄 読み込み中...</div>
                </div>
                
                <div id="profileDirectoryList" style="
                    border: 1px solid #ddd;
                    height: 300px;
                    overflow-y: auto;
                    background: #f9f9f9;
                    border-radius: 4px;
                    padding: 10px;
                ">
                    <div style="text-align: center; color: #999;">ディレクトリを読み込み中...</div>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button onclick="confirmProfileDirectorySelection()" style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                        margin-right: 10px;
                    ">✅ 選択</button>
                    <button onclick="closeProfileDirectoryBrowserModal()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                    ">❌ キャンセル</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }
        
        // プロファイル専用ディレクトリ内容を読み込む
        async function loadProfileDirectoryContents(path) {
            console.log('📂 プロファイル用ディレクトリを読み込み:', path);
            
            const profile = window.currentSelectedProfile;
            if (!profile) {
                console.error('❌ プロファイルが設定されていません');
                return;
            }
            
            const loadingEl = document.getElementById('profileDirectoryLoading');
            const listEl = document.getElementById('profileDirectoryList');
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (listEl) listEl.innerHTML = '';
            
            try {
                // 🔧 FIX: AbortControllerを追加 (30秒)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log('⏰ ディレクトリ読み込みタイムアウト発生 (30秒)');
                    controller.abort('Directory browse timeout after 30 seconds');
                }, 30000);
                
                console.log('📡 ディレクトリ参照API呼び出し開始...');
                const response = await fetch('/api/browse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        host: profile.host,
                        port: parseInt(profile.port),
                        username: profile.username,
                        password: profile.password,
                        protocol: profile.protocol,
                        path: path || '/'
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                console.log('📥 ディレクトリ参照レスポンス受信成功:', response.status);
                
                const data = await response.json();
                console.log('📥 レスポンス:', data);
                
                if (loadingEl) loadingEl.style.display = 'none';
                
                if (data.success) {
                    window.currentBrowsingPath = path;
                    
                    // パス表示を更新
                    const pathEl = document.getElementById('currentProfileBrowsePath');
                    if (pathEl) pathEl.textContent = path;
                    
                    const files = data.files || [];
                    if (listEl) {
                        let html = '';
                        
                        // 親ディレクトリへのリンク
                        if (path !== '/') {
                            html += `
                                <div style="cursor:pointer; padding:8px; border-bottom:1px solid #eee; background:#fff; border-radius:4px; margin-bottom:2px;" 
                                     onclick="navigateToProfileParentDirectory()">
                                    <span style="color:#007bff;">📁 ..</span>
                                </div>
                            `;
                        }
                        
                        // ディレクトリ
                        files.filter(f => f.type === 'directory').forEach(file => {
                            html += `
                                <div style="cursor:pointer; padding:8px; border-bottom:1px solid #eee; background:#fff; border-radius:4px; margin-bottom:2px;" 
                                     onclick="navigateToProfileDirectory('${file.name}')">
                                    <span style="color:#007bff;">📁 ${file.name}</span>
                                </div>
                            `;
                        });
                        
                        // ファイル（表示のみ）
                        files.filter(f => f.type === 'file').forEach(file => {
                            const size = file.size ? `(${(file.size/1024).toFixed(2)} KB)` : '';
                            html += `
                                <div style="padding:8px; border-bottom:1px solid #eee; color:#666; background:#f9f9f9; border-radius:4px; margin-bottom:2px;">
                                    📄 ${file.name} <small>${size}</small>
                                </div>
                            `;
                        });
                        
                        listEl.innerHTML = html || '<div style="text-align:center; color:#999;">ディレクトリは空です</div>';
                    }
                } else {
                    console.error('❌ 参照失敗:', data.message);
                    if (listEl) {
                        listEl.innerHTML = `<div style="color:red; padding:10px;">エラー: ${data.message}</div>`;
                    }
                }
            } catch (error) {
                console.error('❌ 通信エラー:', error);
                if (loadingEl) loadingEl.style.display = 'none';
                if (listEl) {
                    listEl.innerHTML = `<div style="color:red; padding:10px;">通信エラー: ${error.message}</div>`;
                }
            }
        }
        
        // プロファイル専用ナビゲーション関数
        function navigateToProfileDirectory(dirname) {
            const newPath = window.currentBrowsingPath === '/' 
                ? `/${dirname}` 
                : `${window.currentBrowsingPath}/${dirname}`;
            console.log('➡️ プロファイル用ディレクトリに移動:', newPath);
            
            // 選択パスも更新
            const inputEl = document.getElementById('selectedProfileDirectoryPath');
            if (inputEl) inputEl.value = newPath;
            
            loadProfileDirectoryContents(newPath);
        }
        
        function navigateToProfileParentDirectory() {
            const parts = window.currentBrowsingPath.split('/').filter(p => p);
            parts.pop();
            const newPath = parts.length > 0 ? '/' + parts.join('/') : '/';
            console.log('⬆️ プロファイル用親ディレクトリに移動:', newPath);
            
            // 選択パスも更新
            const inputEl = document.getElementById('selectedProfileDirectoryPath');
            if (inputEl) inputEl.value = newPath;
            
            loadProfileDirectoryContents(newPath);
        }
        
        // プロファイル専用ディレクトリ選択確認
        function confirmProfileDirectorySelection() {
            const selectedPath = document.getElementById('selectedProfileDirectoryPath').value || '/';
            const profileDirField = document.getElementById('profile-directory');
            
            console.log('✅ プロファイル用ディレクトリを選択:', selectedPath);
            
            // プロファイルモーダルのディレクトリフィールドを更新
            if (profileDirField) {
                profileDirField.value = selectedPath;
            }
            
            // 通知
            if (window.showToast) {
                window.showToast(`デフォルトディレクトリを ${selectedPath} に設定しました`, 'success');
            }
            
            closeProfileDirectoryBrowserModal();
        }
        
        // プロファイル専用モーダルを閉じる
        function closeProfileDirectoryBrowserModal() {
            const modal = document.getElementById('profileDirectoryBrowserModal');
            if (modal) {
                modal.style.display = 'none';
            }
            // 一時プロファイルをクリア
            window.currentSelectedProfile = null;
        }
        
        // エイリアス関数
        window.browseUploadDirectory = window.browseServerDirectory;
        window.browseServerDirectoryFromSidebar = window.browseServerDirectory;
        
        // スケジュール自動実行チェッカー
        let scheduleCheckInterval = null;
        
        function startScheduleChecker() {
            console.log('⏰ スケジュール自動実行チェッカー開始');
            
            // 既存のインターバルをクリア
            if (scheduleCheckInterval) {
                clearInterval(scheduleCheckInterval);
            }
            
            // 1分ごとにスケジュールをチェック
            scheduleCheckInterval = setInterval(async () => {
                await checkAndExecuteSchedules();
            }, 60000); // 60秒 = 1分
            
            // 初回即座にチェック
            checkAndExecuteSchedules();
        }
        
        async function checkAndExecuteSchedules() {
            const now = new Date();
            const schedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
            
            console.log(`📅 スケジュールチェック: ${now.toLocaleString()}, ${schedules.length}件のスケジュール`);
            
            for (const schedule of schedules) {
                // pendingステータスのみチェック
                if (schedule.status !== 'pending') {
                    continue;
                }
                
                // スケジュール時間の確認
                if (schedule.schedule_time) {
                    const scheduleTime = new Date(schedule.schedule_time);
                    
                    // 現在時刻がスケジュール時刻を過ぎているか確認（1分の余裕を持って）
                    if (now >= scheduleTime) {
                        console.log(`🎯 スケジュール実行時間到達: ${schedule.name}`);
                        
                        // ステータスを実行中に更新
                        schedule.status = 'executing';
                        updateScheduleInStorage(schedule);
                        
                        // スケジュール実行
                        try {
                            await executeSchedule(schedule.id);
                            console.log(`✅ スケジュール実行完了: ${schedule.name}`);
                            
                            // 繰り返し設定の処理
                            if (schedule.schedule_type !== 'once') {
                                // 次回実行時間を計算
                                const nextTime = calculateNextScheduleTime(scheduleTime, schedule.schedule_type);
                                schedule.schedule_time = nextTime.toISOString();
                                schedule.status = 'pending';
                                console.log(`🔄 次回実行予定: ${nextTime.toLocaleString()}`);
                                updateScheduleInStorage(schedule);
                            } else {
                                // 一回のみの場合は完了
                                schedule.status = 'completed';
                                updateScheduleInStorage(schedule);
                            }
                        } catch (error) {
                            console.error(`❌ スケジュール実行エラー: ${schedule.name}`, error);
                            schedule.status = 'failed';
                            updateScheduleInStorage(schedule);
                        }
                        
                        // スケジュールリストと履歴を更新
                        await loadSchedules();
                        await loadHistory();
                    }
                } else {
                    // schedule_timeがない場合は即座に実行（後方互換性）
                    console.log(`⚠️ 即座実行スケジュール: ${schedule.name}`);
                    await executeSchedule(schedule.id);
                }
            }
        }
        
        function calculateNextScheduleTime(currentTime, scheduleType) {
            const nextTime = new Date(currentTime);
            
            switch (scheduleType) {
                case 'daily':
                    nextTime.setDate(nextTime.getDate() + 1);
                    break;
                case 'weekly':
                    nextTime.setDate(nextTime.getDate() + 7);
                    break;
                case 'monthly':
                    nextTime.setMonth(nextTime.getMonth() + 1);
                    break;
                default:
                    // 'once' or unknown type
                    break;
            }
            
            return nextTime;
        }
        
        function updateScheduleInStorage(updatedSchedule) {
            const schedules = JSON.parse(localStorage.getItem('scheduledUploads') || '[]');
            const index = schedules.findIndex(s => s.id === updatedSchedule.id);
            if (index !== -1) {
                schedules[index] = updatedSchedule;
                localStorage.setItem('scheduledUploads', JSON.stringify(schedules));
            }
        }
        
        // ページ読み込み時に初期化
        window.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 システム初期化開始');
            initialize().then(() => {
                console.log('✅ システム初期化完了');
                // スケジュールチェッカーを開始
                startScheduleChecker();
            }).catch(error => {
                console.error('❌ 初期化エラー:', error);
            });
        });
        
        // ページを離れる時にインターバルをクリア
        // テスト履歴追加関数（デバッグ用）
        function addTestHistory() {
            const existingHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
            const newEntry = {
                id: Date.now().toString(),
                file_name: `test_${Date.now()}.csv`,
                profile_name: "Test Server",
                upload_path: "/test/directory",
                uploaded_at: new Date().toISOString(),
                status: Math.random() > 0.5 ? "success" : "failed",
                file_size: Math.floor(Math.random() * 10000) + 1000,
                duration_ms: Math.floor(Math.random() * 5000) + 100,
                protocol: "sftp",
                error_message: Math.random() > 0.5 ? null : "Test error message"
            };
            existingHistory.unshift(newEntry);
            localStorage.setItem('uploadHistory', JSON.stringify(existingHistory));
            console.log('✅ テスト履歴を追加しました:', newEntry);
            loadHistory();
            showToast('テスト履歴を追加しました', 'success');
        }
        
        // 履歴クリア関数（デバッグ用）
        function clearHistory() {
            if (confirm('本当に履歴をクリアしますか？')) {
                localStorage.removeItem('uploadHistory');
                console.log('🗑️ 履歴をクリアしました');
                loadHistory();
                showToast('履歴をクリアしました', 'info');
            }
        }
        
        window.addEventListener('beforeunload', () => {
            if (scheduleCheckInterval) {
                clearInterval(scheduleCheckInterval);
            }
        });

    </script>
</body>
</html>
