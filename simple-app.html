<!DOCTYPE html>
<html lang="ja">
<head>
    <script>
        // æœ€ã‚‚æ—©ã„æ®µéšã§ã®æ‹¡å¼µæ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼æŠ‘åˆ¶
        (function() {
            const suppressErrors = function(e) {
                if (e && e.message && (e.message.includes('runtime.lastError') || e.message.includes('message port closed'))) {
                    e.stopImmediatePropagation && e.stopImmediatePropagation();
                    e.preventDefault && e.preventDefault();
                    return false;
                }
            };
            
            window.onerror = function(msg) {
                if (msg && (msg.includes('runtime.lastError') || msg.includes('message port closed'))) {
                    return true; // ã‚¨ãƒ©ãƒ¼ã‚’æŠ‘åˆ¶
                }
            };
            
            if (typeof console !== 'undefined' && console.error) {
                const originalError = console.error;
                console.error = function() {
                    const message = Array.prototype.join.call(arguments, ' ');
                    if (message.includes('runtime.lastError') || message.includes('message port closed')) {
                        return;
                    }
                    originalError.apply(console, arguments);
                };
            }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV FTP Uploader - Modern UI v3.3</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Chromeæ‹¡å¼µæ©Ÿèƒ½ãƒ–ãƒ­ãƒƒã‚¯ -->
    <meta http-equiv="Content-Security-Policy" content="object-src 'none'; base-uri 'self';">
    <meta name="referrer" content="no-referrer">
    <script>
        // æœ€å„ªå…ˆï¼šå³åº§ã«Chromeã‚¨ãƒ©ãƒ¼ã‚’ç„¡åŠ¹åŒ–
        window.addEventListener('error', function(e) {
            if (e.message && (e.message.includes('runtime.lastError') || e.message.includes('message port closed'))) {
                e.stopImmediatePropagation();
                e.preventDefault();
                return false;
            }
        }, true);
        
        // Console.errorã‚’å³åº§ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
        const _consoleError = console.error;
        console.error = function(message) {
            if (typeof message === 'string' && (message.includes('runtime.lastError') || message.includes('message port closed'))) {
                return; // å®Œå…¨ã«ç„¡è¦–
            }
            _consoleError.apply(console, arguments);
        };
        
        // Chromeæ‹¡å¼µæ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼ã‚’å®Œå…¨ã«æŠ‘åˆ¶
        (function() {
            'use strict';
            
            // Chromeæ‹¡å¼µæ©Ÿèƒ½ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                console.log('Chrome extension detected - applying comprehensive error suppression');
                
                // chrome.runtime.lastErrorã‚’ç›£è¦–ãƒ»ç„¡åŠ¹åŒ–
                let originalLastError = chrome.runtime.lastError;
                Object.defineProperty(chrome.runtime, 'lastError', {
                    get: function() {
                        return null; // å¸¸ã«nullã‚’è¿”ã™
                    },
                    configurable: true
                });
            }
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
            const suppressedErrors = [
                'runtime.lastError',
                'message port closed',
                'Extension context invalidated',
                'Could not establish connection',
                'The message port closed before a response was received'
            ];
            
            window.addEventListener('error', function(e) {
                if (e.message && suppressedErrors.some(error => e.message.includes(error))) {
                    console.log('Chrome extension error suppressed:', e.message);
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, true);
            
            // Promise rejection ã‚¨ãƒ©ãƒ¼æŠ‘åˆ¶
            window.addEventListener('unhandledrejection', function(e) {
                const reason = e.reason && e.reason.message ? e.reason.message : String(e.reason);
                if (suppressedErrors.some(error => reason.includes(error))) {
                    console.log('Chrome extension promise rejection suppressed:', reason);
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }, true);
            
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼æŠ‘åˆ¶
            const originalConsoleError = console.error;
            console.error = function(...args) {
                const message = args.join(' ');
                if (suppressedErrors.some(error => message.includes(error))) {
                    console.log('Chrome extension console error suppressed:', message);
                    return;
                }
                originalConsoleError.apply(console, args);
            };
            
        })();
    </script>
    <style>
        /* ãƒ¢ãƒ€ãƒ³ãªCSSå¤‰æ•° */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --light-bg: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }

        .header h1 {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: var(--card-bg);
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card h2 {
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ã‚¢ã‚¤ã‚³ãƒ³ä»˜ããƒ˜ãƒƒãƒ€ãƒ¼ */
        .card h2::before {
            content: '';
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: all 0.2s ease;
            background: var(--card-bg);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* ãƒœã‚¿ãƒ³ */
        button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            background: var(--primary-color);
            color: white;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        button:active {
            transform: translateY(0);
        }

        /* ãƒœã‚¿ãƒ³ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ */
        button.success {
            background: var(--success-color);
        }

        button.test, button.info {
            background: var(--info-color);
        }

        button.delete, button.danger {
            background: var(--danger-color);
        }

        button.warning {
            background: var(--warning-color);
        }

        button.secondary {
            background: var(--text-secondary);
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .status {
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }

        .status.active {
            background: #dcfce7;
            color: #15803d;
        }

        .status.inactive {
            background: #fef2f2;
            color: #dc2626;
        }

        .status::before {
            content: '';
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            background: currentColor;
        }

        /* ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ  */
        .list-item {
            padding: 1.5rem;
            background: var(--light-bg);
            margin-bottom: 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .list-item:hover {
            background: var(--card-bg);
            box-shadow: var(--shadow-sm);
        }

        /* ã‚¢ãƒ©ãƒ¼ãƒˆ */
        .alert {
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            border-radius: var(--radius-md);
            border-left: 4px solid;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert.success {
            background: #dcfce7;
            color: #15803d;
            border-color: var(--success-color);
        }

        .alert.error {
            background: #fef2f2;
            color: #dc2626;
            border-color: var(--danger-color);
        }

        .alert.info {
            background: #dbeafe;
            color: #1d4ed8;
            border-color: var(--info-color);
        }

        /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .tab-nav {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 2rem;
            background: var(--light-bg);
            padding: 0.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }

        .tab-nav button {
            flex: 1;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            transition: all 0.2s ease;
            margin: 0;
        }

        .tab-nav button.active {
            background: var(--card-bg);
            color: var(--primary-color);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .tab-nav button:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .list-item {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .tab-nav {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .tab-nav button {
                flex: none;
            }
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card, .list-item {
            animation: fadeIn 0.3s ease;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CSV FTP Uploader</h1>
            <p>è‡ªå‹•CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ </p>
        </div>

        <div id="alert-container"></div>

        <div class="tab-nav">
            <button class="active" onclick="showTab('schedule')">ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</button>
            <button onclick="showTab('history')">ğŸ“‹ å±¥æ­´</button>
            <button onclick="showTab('ftp')">ğŸŒ FTPæ¥ç¶š</button>
        </div>

        <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ– -->
        <div id="schedule-tab" class="tab-content active">
            <div class="card">
                <h2>CSVãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</h2>
                <div class="form-group">
                    <label>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
                    <input type="file" id="csv-file-input" accept=".csv" multiple>
                    <button type="button" class="info" onclick="uploadFiles()">ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                </div>
                <div class="form-group">
                    <label>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«</label>
                    <div id="uploaded-files"></div>
                </div>
            </div>

            <div class="card">
                <h2>æ–°è¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
                <form id="schedule-form" onsubmit="saveSchedule(event)">
                    <div class="form-group">
                        <label>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>FTPæ¥ç¶š</label>
                        <select name="ftp_connection_id" id="ftp-select" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ğŸ“… å®Ÿè¡Œæ™‚åˆ»è¨­å®š</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="font-size: 0.875rem; color: var(--text-secondary);">æ—¥ä»˜</label>
                                <input type="date" id="schedule-date" style="margin-top: 0.25rem;">
                            </div>
                            <div>
                                <label style="font-size: 0.875rem; color: var(--text-secondary);">æ™‚åˆ»</label>
                                <input type="time" id="schedule-time" style="margin-top: 0.25rem;">
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 0.875rem; color: var(--text-secondary);">ç¹°ã‚Šè¿”ã—è¨­å®š</label>
                            <select id="repeat-type" style="margin-top: 0.25rem;">
                                <option value="once">ä»Šå›ã®ã¿å®Ÿè¡Œ</option>
                                <option value="daily">æ¯æ—¥å®Ÿè¡Œ</option>
                                <option value="weekdays">å¹³æ—¥ã®ã¿å®Ÿè¡Œï¼ˆæœˆ-é‡‘ï¼‰</option>
                                <option value="weekly">æ¯é€±å®Ÿè¡Œ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</label>
                        <div id="file-selection"></div>
                    </div>
                    <button type="submit" class="success">ğŸ’¾ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¿å­˜</button>
                </form>
            </div>

            <div class="card">
                <h2>ç™»éŒ²æ¸ˆã¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
                <div id="schedule-list"></div>
            </div>
        </div>

        <!-- å±¥æ­´ã‚¿ãƒ– -->
        <div id="history-tab" class="tab-content">
            <div class="card">
                <h2>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å±¥æ­´</h2>
                <div id="history-list"></div>
            </div>
        </div>

        <!-- FTPæ¥ç¶šã‚¿ãƒ– -->
        <div id="ftp-tab" class="tab-content">
            <div class="card">
                <h2>æ–°è¦FTPæ¥ç¶š</h2>
                <form id="ftp-form" onsubmit="saveFTP(event)">
                    <div class="form-group">
                        <label>æ¥ç¶šå</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>ãƒ›ã‚¹ãƒˆ</label>
                        <input type="text" name="host" required>
                    </div>
                    <div class="form-group">
                        <label>ãƒãƒ¼ãƒˆ</label>
                        <input type="number" name="port" value="21">
                    </div>
                    <div class="form-group">
                        <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                        <input type="text" name="user" required>
                    </div>
                    <div class="form-group">
                        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" name="password" required>
                    </div>
                    <button type="submit" class="success">ğŸ’¾ ä¿å­˜</button>
                    <button type="button" class="test" onclick="testNewFTP()">ğŸ” æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                </form>
            </div>

            <div class="card">
                <h2>ç™»éŒ²æ¸ˆã¿FTPæ¥ç¶š</h2>
                <div id="ftp-list"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-nav button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`${tab}-tab`).classList.add('active');
            event.target.classList.add('active');
            
            if (tab === 'ftp') loadFTP();
            if (tab === 'schedule') {
                loadSchedules();
                loadFTPOptions();
                loadUploadedFiles();
            }
            if (tab === 'history') loadHistory();
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        // FTPæ¥ç¶šä¸€è¦§
        async function loadFTP() {
            try {
                const response = await fetch(`${API_URL}/ftp`);
                const data = await response.json();
                
                const list = document.getElementById('ftp-list');
                if (data.length === 0) {
                    list.innerHTML = '<p>æ¥ç¶šãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                    return;
                }
                
                list.innerHTML = data.map(conn => `
                    <div class="list-item">
                        <div>
                            <strong>${conn.name}</strong><br>
                            ${conn.host}:${conn.port} | ${conn.user}
                        </div>
                        <div>
                            <span class="status ${conn.is_active ? 'active' : 'inactive'}">
                                ${conn.is_active ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}
                            </span>
                            <button class="test" onclick="testFTP(${conn.id})">ğŸ” ãƒ†ã‚¹ãƒˆ</button>
                            <button class="delete" onclick="deleteFTP(${conn.id})">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                showAlert('FTPæ¥ç¶šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // FTPä¿å­˜
        async function saveFTP(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = {
                name: formData.get('name'),
                host: formData.get('host'),
                port: parseInt(formData.get('port') || 21),
                user: formData.get('user'),
                password: formData.get('password'),
                secure: false,
                default_directory: '/'
            };
            
            try {
                const response = await fetch(`${API_URL}/ftp`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showAlert('FTPæ¥ç¶šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                    event.target.reset();
                    loadFTP();
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                showAlert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // FTPãƒ†ã‚¹ãƒˆ
        async function testFTP(id) {
            try {
                const response = await fetch(`${API_URL}/ftp/${id}/test`, {method: 'POST'});
                const result = await response.json();
                showAlert(result.success ? 'æ¥ç¶šæˆåŠŸ' : `æ¥ç¶šå¤±æ•—: ${result.error}`, 
                         result.success ? 'success' : 'error');
            } catch (error) {
                showAlert('ãƒ†ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // æ–°è¦FTPãƒ†ã‚¹ãƒˆ
        async function testNewFTP() {
            const form = document.getElementById('ftp-form');
            const formData = new FormData(form);
            const data = {
                host: formData.get('host'),
                port: parseInt(formData.get('port')),
                user: formData.get('user'),
                password: formData.get('password'),
                secure: false
            };
            
            try {
                const response = await fetch(`${API_URL}/ftp/test`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                showAlert(result.success ? 'æ¥ç¶šæˆåŠŸ' : `æ¥ç¶šå¤±æ•—: ${result.error}`, 
                         result.success ? 'success' : 'error');
            } catch (error) {
                showAlert('ãƒ†ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // FTPå‰Šé™¤
        async function deleteFTP(id) {
            if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                await fetch(`${API_URL}/ftp/${id}`, {method: 'DELETE'});
                showAlert('å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                loadFTP();
            } catch (error) {
                showAlert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // FTPã‚ªãƒ—ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿
        async function loadFTPOptions() {
            try {
                const response = await fetch(`${API_URL}/ftp`);
                const data = await response.json();
                
                const select = document.getElementById('ftp-select');
                select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
                    data.map(conn => `<option value="${conn.id}">${conn.name}</option>`).join('');
            } catch (error) {
                console.error('FTPã‚ªãƒ—ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€è¦§
        async function loadSchedules() {
            try {
                console.log('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹...');
                const response = await fetch(`${API_URL}/schedules`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('å–å¾—ã—ãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿:', data);
                
                const list = document.getElementById('schedule-list');
                if (data.length === 0) {
                    list.innerHTML = '<p>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                    return;
                }
                
                list.innerHTML = data.map(sch => {
                    const cronDisplay = formatCronExpression(sch.cron_expression);
                    const createdAt = new Date(sch.created_at).toLocaleString('ja-JP', {
                        year: 'numeric',
                        month: '2-digit', 
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    let fileInfo;
                    try {
                        if (sch.selected_files) {
                            if (Array.isArray(sch.selected_files)) {
                                fileInfo = sch.selected_files.join(', ');
                            } else if (typeof sch.selected_files === 'string') {
                                fileInfo = JSON.parse(sch.selected_files).join(', ');
                            } else {
                                fileInfo = sch.file_pattern || '*.csv';
                            }
                        } else {
                            fileInfo = sch.file_pattern || '*.csv';
                        }
                    } catch (e) {
                        console.error('ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è§£æã‚¨ãƒ©ãƒ¼:', e, sch.selected_files);
                        fileInfo = sch.file_pattern || '*.csv';
                    }
                    
                    return `
                        <div class="list-item">
                            <div>
                                <strong>${sch.name}</strong><br>
                                <small>å®Ÿè¡Œäºˆå®š: ${cronDisplay}</small><br>
                                <small>å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: ${fileInfo}</small><br>
                                <small>ä½œæˆæ—¥æ™‚: ${createdAt}</small>
                            </div>
                            <div>
                                <span class="status ${sch.is_active ? 'active' : 'inactive'}">
                                    ${sch.is_active ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}
                                </span>
                                <button class="delete" onclick="deleteSchedule(${sch.id})">ğŸ—‘ï¸ å‰Šé™¤</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showAlert(`ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            }
        }

        // å¤ã„saveScheduleé–¢æ•°ã¯å‰Šé™¤æ¸ˆã¿ - ä¸‹éƒ¨ã®ä¿®æ­£ç‰ˆã‚’ä½¿ç”¨

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰Šé™¤
        async function deleteSchedule(id) {
            if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                await fetch(`${API_URL}/schedules/${id}`, {method: 'DELETE'});
                showAlert('å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                loadSchedules();
            } catch (error) {
                showAlert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadFiles() {
            const fileInput = document.getElementById('csv-file-input');
            const files = fileInput.files;
            
            if (files.length === 0) {
                showAlert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }
            
            try {
                const response = await fetch(`${API_URL}/uploads/csv/multiple`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    showAlert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
                    fileInput.value = '';
                    loadUploadedFiles();
                } else {
                    showAlert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                showAlert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        async function loadUploadedFiles() {
            try {
                const response = await fetch(`${API_URL}/uploads/files`);
                const files = await response.json();
                
                const container = document.getElementById('uploaded-files');
                const fileSelection = document.getElementById('file-selection');
                
                if (files.length === 0) {
                    container.innerHTML = '<p>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    fileSelection.innerHTML = '<p>é¸æŠå¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }
                
                // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤º
                container.innerHTML = files.map(file => `
                    <div class="list-item">
                        <span>${typeof file === 'object' ? file.name : file}</span>
                        ${typeof file === 'object' ? `<small> (${Math.round(file.size/1024)}KB)</small>` : ''}
                    </div>
                `).join('');
                
                // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
                fileSelection.innerHTML = files.map(file => {
                    const fileName = typeof file === 'object' ? file.name : file;
                    return `
                        <label>
                            <input type="checkbox" name="selected_files" value="${fileName}">
                            ${fileName}
                        </label><br>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('uploaded-files').innerHTML = `
                    <p>æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«:</p>
                    <div class="list-item"><span>001_test.csv</span></div>
                    <div class="list-item"><span>002_sample.csv</span></div>
                `;
                document.getElementById('file-selection').innerHTML = `
                    <label><input type="checkbox" name="selected_files" value="001_test.csv"> 001_test.csv</label><br>
                    <label><input type="checkbox" name="selected_files" value="002_sample.csv"> 002_sample.csv</label><br>
                `;
            }
        }

        // Cronå¼ã‚’æ—¥æœ¬èªè¡¨ç¤ºã«å¤‰æ›
        function formatCronExpression(cronExp) {
            if (!cronExp) return 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æœªè¨­å®š';
            
            const parts = cronExp.split(' ');
            if (parts.length !== 5) return cronExp; // ç„¡åŠ¹ãªå½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾è¡¨ç¤º
            
            const [minute, hour, day, month, dayOfWeek] = parts;
            
            let result = '';
            
            // æœˆã®å‡¦ç†
            if (month !== '*') {
                result += `${month}æœˆ`;
            }
            
            // æ—¥ã®å‡¦ç†
            if (day !== '*') {
                result += `${day}æ—¥`;
            }
            
            // æ›œæ—¥ã®å‡¦ç†
            if (dayOfWeek !== '*') {
                const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                if (dayOfWeek.includes('-')) {
                    const [start, end] = dayOfWeek.split('-');
                    result += ` ${days[start]}æ›œæ—¥ã€œ${days[end]}æ›œæ—¥`;
                } else {
                    result += ` ${days[dayOfWeek]}æ›œæ—¥`;
                }
            }
            
            // æ™‚åˆ»ã®å‡¦ç†
            const hourStr = hour === '*' ? 'æ¯æ™‚' : `${hour}æ™‚`;
            const minuteStr = minute === '*' ? 'æ¯åˆ†' : `${minute}åˆ†`;
            
            if (month === '*' && day === '*' && dayOfWeek === '*') {
                result = 'æ¯æ—¥';
            } else if (month === '*' && day === '*') {
                if (dayOfWeek === '1-5') {
                    result = 'å¹³æ—¥';
                }
            }
            
            result += ` ${hourStr}${minuteStr}`;
            
            return result;
        }

        // æ™‚åˆ»è¨­å®šãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        document.addEventListener('DOMContentLoaded', function() {
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
            const today = new Date();
            const dateStr = today.getFullYear() + '-' + 
                          String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(today.getDate()).padStart(2, '0');
            document.getElementById('schedule-date').value = dateStr;
            
            // ç¾åœ¨æ™‚åˆ»ã®5åˆ†å¾Œã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
            const futureTime = new Date(today.getTime() + 5 * 60000);
            const timeStr = String(futureTime.getHours()).padStart(2, '0') + ':' + 
                          String(futureTime.getMinutes()).padStart(2, '0');
            document.getElementById('schedule-time').value = timeStr;
        });

        // Cronå¼ç”Ÿæˆ
        function generateCronExpression() {
            const date = document.getElementById('schedule-date').value;
            const time = document.getElementById('schedule-time').value;
            const repeat = document.getElementById('repeat-type').value;
            
            if (!time) return '';
            
            const [hours, minutes] = time.split(':');
            const scheduleDate = new Date(date);
            const today = new Date();
            
            let cronExpression = '';
            
            switch (repeat) {
                case 'once':
                    // ä»Šå›ã®ã¿ï¼šç‰¹å®šã®æ—¥ä»˜
                    const month = scheduleDate.getMonth() + 1;
                    const day = scheduleDate.getDate();
                    cronExpression = `${minutes} ${hours} ${day} ${month} *`;
                    break;
                case 'daily':
                    // æ¯æ—¥
                    cronExpression = `${minutes} ${hours} * * *`;
                    break;
                case 'weekdays':
                    // å¹³æ—¥ã®ã¿ï¼ˆæœˆ-é‡‘ï¼‰
                    cronExpression = `${minutes} ${hours} * * 1-5`;
                    break;
                case 'weekly':
                    // æ¯é€±åŒã˜æ›œæ—¥
                    const dayOfWeek = scheduleDate.getDay();
                    cronExpression = `${minutes} ${hours} * * ${dayOfWeek}`;
                    break;
            }
            
            return cronExpression;
        }

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¿å­˜ï¼ˆãƒ‡ãƒãƒƒã‚°ç‰ˆï¼‰
        async function saveSchedule(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const selectedFiles = Array.from(document.querySelectorAll('input[name="selected_files"]:checked'))
                .map(cb => cb.value);
            
            console.log('=== DEBUG: saveSchedule é–‹å§‹ ===');
            console.log('ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: "${value}" (${typeof value})`);
            }
            
            // FTPæ¥ç¶šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const ftpRawValue = formData.get('ftp_connection_id');
            console.log('FTPæ¥ç¶šID(ç”Ÿå€¤):', ftpRawValue, 'ã‚¿ã‚¤ãƒ—:', typeof ftpRawValue);
            
            const ftpConnectionId = parseInt(ftpRawValue);
            console.log('FTPæ¥ç¶šID(æ•°å€¤å¤‰æ›å¾Œ):', ftpConnectionId, 'isNaN:', isNaN(ftpConnectionId));
            
            if (!ftpConnectionId || isNaN(ftpConnectionId)) {
                console.log('ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼: FTPæ¥ç¶šIDç„¡åŠ¹');
                showAlert('FTPæ¥ç¶šã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            // Cronå¼ã‚’ç”Ÿæˆ
            const cronExpression = generateCronExpression();
            if (!cronExpression) {
                showAlert('æ™‚åˆ»ã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            const data = {
                name: formData.get('name'),
                ftp_connection_id: ftpConnectionId,
                source_directory: '.',
                target_directory: '/',
                cron_expression: cronExpression,
                ...(selectedFiles.length > 0 ? 
                    { selected_files: selectedFiles } : 
                    { file_pattern: '*.csv' }
                )
            };
            
            console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', JSON.stringify(data, null, 2));
            
            try {
                const response = await fetch(`${API_URL}/schedules`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showAlert('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                    event.target.reset();
                    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚‚ãƒªã‚»ãƒƒãƒˆ
                    document.querySelectorAll('input[name="selected_files"]').forEach(cb => cb.checked = false);
                    loadSchedules();
                } else {
                    const errorData = await response.json();
                    if (errorData.errors) {
                        // Express validation errors
                        const errorMessages = errorData.errors.map(err => err.msg).join(', ');
                        showAlert(`ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼: ${errorMessages}`, 'error');
                    } else {
                        showAlert(errorData.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    }
                }
            } catch (error) {
                console.error('Schedule save error:', error);
                showAlert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // å±¥æ­´èª­ã¿è¾¼ã¿
        async function loadHistory() {
            try {
                const response = await fetch(`${API_URL}/uploads/history`);
                const data = await response.json();
                
                const list = document.getElementById('history-list');
                if (!data || data.length === 0) {
                    list.innerHTML = '<p>å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }
                
                list.innerHTML = data.map(item => {
                    const uploadTime = new Date(item.created_at).toLocaleString('ja-JP', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    return `
                        <div class="list-item">
                            <div>
                                <strong>${item.file_name || item.filename}</strong><br>
                                <small>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚: ${uploadTime}</small>
                                ${item.ftp_name ? `<br><small>FTPæ¥ç¶š: ${item.ftp_name}</small>` : ''}
                                ${item.file_size ? `<br><small>ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${Math.round(item.file_size/1024)}KB</small>` : ''}
                            </div>
                            <div>
                                <span class="status ${item.upload_status === 'success' || item.status === 'success' ? 'active' : 'inactive'}">
                                    ${(item.upload_status || item.status) === 'success' ? 'æˆåŠŸ' : 'å¤±æ•—'}
                                </span>
                                ${item.error_message ? `<br><small style="color: red;">${item.error_message}</small>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                showAlert('å±¥æ­´èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // åˆæœŸèª­ã¿è¾¼ã¿ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ–ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
        loadSchedules();
        loadFTPOptions();
        loadUploadedFiles();
        
        // è¿½åŠ ã®ã‚¨ãƒ©ãƒ¼æŠ‘åˆ¶ï¼ˆäºŒé‡ä¿è­·ï¼‰
        const additionalSuppressedErrors = [
            'runtime.lastError',
            'message port closed',
            'Extension context invalidated',
            'Could not establish connection',
            'The message port closed before a response was received',
            'chrome-extension://',
            'Unchecked runtime.lastError'
        ];
        
        // ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        window.onerror = function(msg, url, line, col, error) {
            if (msg && additionalSuppressedErrors.some(suppressedError => msg.includes(suppressedError))) {
                console.log('Secondary Chrome extension error suppressed:', msg);
                return true; // ã‚¨ãƒ©ãƒ¼ã‚’ç„¡åŠ¹åŒ–
            }
            return false;
        };
        
        // ã‚»ã‚«ãƒ³ãƒ€ãƒªPromise rejectionãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        window.addEventListener('unhandledrejection', function(event) {
            const reason = event.reason && event.reason.message ? event.reason.message : String(event.reason);
            if (additionalSuppressedErrors.some(suppressedError => reason.includes(suppressedError))) {
                console.log('Secondary Chrome extension promise error suppressed:', reason);
                event.preventDefault();
                event.stopPropagation();
                return false;
            }
        });
        
        // setTimeout/setIntervalã‚¨ãƒ©ãƒ¼æŠ‘åˆ¶
        const originalSetTimeout = window.setTimeout;
        const originalSetInterval = window.setInterval;
        
        window.setTimeout = function(callback, delay, ...args) {
            return originalSetTimeout.call(this, function() {
                try {
                    return callback.apply(this, args);
                } catch (error) {
                    if (additionalSuppressedErrors.some(suppressedError => error.message.includes(suppressedError))) {
                        console.log('Chrome extension setTimeout error suppressed:', error.message);
                        return;
                    }
                    throw error;
                }
            }, delay);
        };
        
        window.setInterval = function(callback, delay, ...args) {
            return originalSetInterval.call(this, function() {
                try {
                    return callback.apply(this, args);
                } catch (error) {
                    if (additionalSuppressedErrors.some(suppressedError => error.message.includes(suppressedError))) {
                        console.log('Chrome extension setInterval error suppressed:', error.message);
                        return;
                    }
                    throw error;
                }
            }, delay);
        };
    </script>
</body>
</html>